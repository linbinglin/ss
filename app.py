import streamlit as st
import requests
import json

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å…¨æµç¨‹æ— æŸåˆ†é•œå¤§å¸ˆ v9.0", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”å·¥ä½œå®¤é…ç½®")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "grok-beta", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é€»è¾‘é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("è¯·è¾“å…¥å…·ä½“çš„ Model ID (å¦‚: grok-3)")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§å…¨æµç¨‹åˆ†é•œç³»ç»Ÿ v9.0")
st.error("ğŸš€ æ ¸å¿ƒçº¢çº¿ï¼šä¸¥ç¦é—æ¼åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ï¼å•é•œå¤´ä¸Šé™ 35 å­—ï¼ä¸€é•œä¸€æ„ï¼")

# --- ç¬¬ä¸€é˜¶æ®µï¼šæ— æŸè§†è§‰ç²¾ç»†åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šæ— æŸæ–‡æœ¬ç²¾å‡†åˆ†é•œï¼ˆåŒé‡æ¨ç†å¼•æ“ï¼‰")

col_left, col_right = st.columns(2)

with col_left:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„åŸå§‹æ–‡æ¡ˆ...")
    
    if st.button("ğŸš€ æ‰§è¡Œæ— æŸç²¾ç»†åˆ†é•œ"):
        if not api_key or not final_model_id:
            st.error("è¯·å®Œå–„é…ç½®ä¿¡æ¯ã€‚")
        elif not raw_script:
            st.warning("å†…å®¹ä¸ºç©ºã€‚")
        else:
            with st.spinner("æ­£åœ¨è¿›è¡ŒåŒé‡é€»è¾‘æ¨ç†ï¼šè§†è§‰å»ºæ¨¡ + æ— æŸåˆ‡å‰²..."):
                # å¼ºåŒ–ç‰ˆç¬¬ä¸€æ­¥ Promptï¼šæ ¸å¿ƒæ˜¯â€œæ— æŸâ€å’Œâ€œå¯¼æ¼”æ€ç»´â€
                step1_prompt = """
ä½ æ˜¯ä¸€ä¸ªæå…¶ä¸¥è°¨çš„æ¼«å‰§åˆ†é•œå¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¤„ç†æ–‡æ¡ˆï¼Œä¸º 9:16 ç«–å±æ¼«å‰§æä¾›ç²¾å‡†çš„é•œå¤´åˆ‡åˆ†ç‚¹ã€‚

### æ ¸å¿ƒé™åˆ¶ï¼ˆç»ä¸å¯è¿åï¼‰ï¼š
1. **å­—ç¬¦çº§å¿ å®åº¦**ï¼šä½ å¿…é¡»ä¿ç•™åŸæ–‡ä¸­çš„ã€æ¯ä¸€ä¸ªå­—ã€‘ã€‚ä¸¥ç¦åˆ é™¤ã€ä¸¥ç¦ä¿®æ”¹ã€ä¸¥ç¦æ·»åŠ ä»»ä½•å­—è¯ã€‚å¦‚æœåŸæ–‡æœ‰é”™åˆ«å­—ä¹Ÿè¦ç…§å¸¸ä¿ç•™ã€‚
2. **35å­—/5ç§’ç‰©ç†å‡†åˆ™**ï¼šå•ä¸ªåˆ†é•œæ–‡æ¡ˆç»å¯¹ä¸èƒ½è¶…è¿‡ 35 ä¸ªæ±‰å­—ã€‚å¦‚æœä¸€å¥è¯é•¿è¾¾ 40 å­—ï¼Œå¿…é¡»åœ¨ä¸­é—´å¯»æ‰¾è¯­æ„Ÿåœé¡¿å¤„æ‹†åˆ†ä¸ºä¸¤é•œã€‚
3. **è§†è§‰åŸå­åŒ–**ï¼šä¸€ä¸ªåˆ†é•œåªèƒ½æœ‰ä¸€ä¸ªæ ¸å¿ƒè§†è§‰é‡å¿ƒã€‚
   - åŠ¨ä½œå˜äº†ï¼Œå¿…é¡»æ‹†ã€‚
   - ä¸»è¯­å˜äº†ï¼ˆä»–->å¥¹ï¼‰ï¼Œå¿…é¡»æ‹†ã€‚
   - åœºæ™¯å˜äº†ï¼Œå¿…é¡»æ‹†ã€‚
   - å³ä½¿æ–‡æ¡ˆåªæœ‰3ä¸ªå­—ï¼ˆå¦‚ï¼šâ€œä»–ç¬‘äº†â€ï¼‰ï¼Œå¦‚æœå®ƒæ˜¯ä¸€ä¸ªé‡è¦çš„æƒ…ç»ªç‚¹ï¼Œä¹Ÿè¯·ç‹¬ç«‹æˆé•œã€‚

### æ‰§è¡Œæµç¨‹ï¼ˆä¸¤éæ¨ç†ï¼‰ï¼š
- **ç¬¬ä¸€éï¼ˆå…¨å±€æ„æ€ï¼‰**ï¼šè®¤çœŸé˜…è¯»å…¨æ–‡ï¼Œç†è§£ 9:16 æ¯”ä¾‹ä¸‹çš„é•œå¤´åˆ‡æ¢æ„Ÿï¼Œæ‰¾å‡ºè§†è§‰ä¸Šçš„èµ·æ‰¿è½¬åˆã€‚
- **ç¬¬äºŒéï¼ˆæ— æŸåˆ‡å‰²ï¼‰**ï¼šåœ¨ç¡®ä¿ 100% è¿˜åŸåŸæ–‡çš„å‰æä¸‹ï¼Œæ ¹æ®è§†è§‰é‡å¿ƒå’Œ 35 å­—é™æ—¶è¿›è¡Œåˆ‡å‰²ã€‚

### è¾“å‡ºæ ¼å¼ï¼š
ä»…è¾“å‡ºå¸¦åºå·çš„åˆ†é•œåˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š
1.å†…å®¹...
2.å†…å®¹...
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.0 # å¼ºåˆ¶é›¶éšæœºæ€§ï¼Œç¡®ä¿ä¸ä¸¢å­—
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_output'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œå¤±è´¥ï¼š{str(e)}")

with col_right:
    final_script_v1 = st.text_area("2. åˆ†é•œç»“æœé¢„è§ˆï¼ˆè¯·æ ¸å¯¹å­—æ•°ä¸å®Œæ•´æ€§ï¼‰", 
                                  value=st.session_state.get('step1_output', ''), 
                                  height=400)
    st.caption("ğŸ’¡ å¯¼æ¼”æç¤ºï¼šåˆ†é•œæ˜¯ä¸ºäº†å‡ºå›¾å’Œè§†é¢‘ã€‚å¦‚æœå‘ç°æŸä¸€è¡Œä¾ç„¶æ¶µç›–äº†ä¸¤ä¸ªä¸åŒç”»é¢ï¼Œè¯·æ‰‹åŠ¨å›è½¦å¹¶é‡æ’åºå·ã€‚")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æŒ‡ä»¤é›†ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æè¿°ç”Ÿæˆ (Midjourney + å³æ¢¦)")

use_char = st.checkbox("æ˜¯å¦åŠ å…¥ã€è§’è‰²ä¸€è‡´æ€§ã€‘æè¿°ï¼Ÿ", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥è§’è‰²å¤–è²Œ/ç€è£…è®¾å®šï¼ˆä¾‹å¦‚ï¼šèµµå°˜ï¼Œç„è‰²é”¦è¢ï¼Œå†·å³»...ï¼‰", height=150)

if st.button("ğŸ¨ ç”Ÿæˆå…¨å¥—è§†è§‰æè¿°æŒ‡ä»¤"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µã€‚")
    else:
        with st.spinner("æ­£åœ¨æ ¹æ® 9:16 æ„å›¾ç”Ÿæˆè§†è§‰æ–¹æ¡ˆ..."):
            # ç¬¬äºŒæ­¥ Promptï¼šå¼ºè°ƒç”»é¢æ¯”ä¾‹å’ŒåŠ¨æ€
            step2_prompt = f"""
ä½ æ˜¯ä¸€åèµ„æ·±è§†è§‰æ€»ç›‘ã€‚è¯·æ ¹æ®åˆ†é•œå†…å®¹ç”Ÿæˆ MJ æç¤ºè¯å’Œè§†é¢‘åŠ¨æ€æŒ‡ä»¤ã€‚

### è§’è‰²å‚è€ƒè®¾å®šï¼š
{char_detail}

### ç”Ÿæˆå‡†åˆ™ï¼š
1. ã€ç”»é¢æè¿° (MJ)ã€‘ï¼šæè¿° 9:16 æ¯”ä¾‹çš„é™æ€è‰ºæœ¯ã€‚
   - å¿…é¡»åŒ…å«ï¼šå›ºå®šåœºæ™¯ã€å›ºå®šè§’è‰²ï¼ˆå¼•ç”¨è®¾å®šï¼‰ã€å…·ä½“æ™¯åˆ«ï¼ˆç«–å±å¤šç”¨ç‰¹å†™/ä¸­æ™¯ï¼‰ã€è§†è§’ã€å…‰å½±ã€æ°›å›´ã€‚
   - **ç¦æ­¢åŠ¨è¯**ï¼Œåªå†™ç”»é¢å†…å­˜åœ¨çš„å…ƒç´ ã€‚
2. ã€è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)ã€‘ï¼šæè¿° 5 ç§’å†…çš„åŠ¨æ€è½¨è¿¹ã€‚
   - åŸºäº MJ ç”»é¢è¿›è¡Œæ¼”å˜ã€‚
   - æè¿°ï¼šå£å‹å¼ åˆã€çœ¼ç¥è½¬åŠ¨ã€èº«ä½“å¾®åŠ¨ã€é•œå¤´æ¨æ‹‰æˆ–ç§»åŠ¨ã€‚
   - åŠ¨ä½œå¿…é¡»åœ¨ 5 ç§’å†…è‡ªç„¶å®Œæˆã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼šåœºæ™¯å†…å®¹ï¼Œ[è§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´æè¿°è¯ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼šåŠ¨æ€åŠ¨ä½œæè¿°ï¼Œé•œå¤´ç§»åŠ¨è·¯å¾„ï¼Œæƒ…ç»ªèµ·ä¼æ„Ÿ
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.3
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=300)
                st.session_state['step2_output'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"æŒ‡ä»¤ç”Ÿæˆå¤±è´¥ï¼š{str(e)}")

if 'step2_output' in st.session_state:
    st.text_area("ğŸ“‹ æœ€ç»ˆå¯¼æ¼”åˆ†é•œç¨¿é¢„è§ˆ", st.session_state['step2_output'], height=600)
    st.download_button("ğŸ“¥ å¯¼å‡ºåˆ†é•œå…¨æ¡ˆ", st.session_state['step2_output'], file_name="æ— æŸåˆ†é•œå¯¼æ¼”ç¨¿.txt")
