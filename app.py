import streamlit as st
from openai import OpenAI
import re

# 1. é¡µé¢é…ç½®
st.set_page_config(page_title="AI å™äº‹å¯¼æ¼”ç³»ç»Ÿ v5.0", layout="wide", page_icon="ğŸ¬")

if 'storyboard_raw' not in st.session_state:
    st.session_state['storyboard_raw'] = ""

# 2. ä¾§è¾¹æ ï¼šAPI é…ç½®
st.sidebar.title("ğŸ¬ å¯¼æ¼”å·¥ä½œç«™")
api_key = st.sidebar.text_input("1. API Key", type="password")
base_url = st.sidebar.text_input("2. æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")

model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "è‡ªå®šä¹‰æ¨¡å‹"]
selected_option = st.sidebar.selectbox("3. é€‰æ‹©å¤§è„‘ (å»ºè®®ç”¨ GPT-4o æˆ– Claude)", model_options)
if selected_option == "è‡ªå®šä¹‰æ¨¡å‹":
    model_id = st.sidebar.text_input("Model ID")
else:
    model_id = selected_option

st.title("ğŸ¥ AI å™äº‹å¯¼æ¼”åˆ†é•œç³»ç»Ÿ")
st.markdown("---")

# --- ç¬¬ä¸€é˜¶æ®µï¼šå™äº‹é€»è¾‘æ‹†è§£ ---
st.header("ç¬¬ä¸€æ­¥ï¼šå™äº‹èŠ‚å¥ä¸é•œå¤´é€»è¾‘åˆ†æ")
st.info("ğŸ’¡ **å¯¼æ¼”é€»è¾‘**ï¼šAI ä¼šå…ˆæ·±åº¦é˜…è¯»åŸæ–‡ï¼Œåˆ†ææ¯ä¸€å¤„æƒ…æ„Ÿè½¬æŠ˜ã€åŠ¨ä½œè¿è´¯æ€§ä»¥åŠè§†è§‰é‡ç‚¹ï¼Œç„¶åå†ç¡®å®šåˆ†é•œåˆ‡åˆ†ç‚¹ã€‚")

uploaded_file = st.file_uploader("ğŸ“‚ ä¸Šä¼ æ–‡æ¡ˆ (TXT)", type=['txt'])

if uploaded_file:
    raw_text = uploaded_file.getvalue().decode("utf-8", errors="ignore")
    # ä¿æŒæ–‡æ¡ˆçš„è¿è´¯æ€§
    full_story = " ".join(raw_text.split())

    if st.button("ğŸš€ å¼€å§‹æ·±åº¦å‰§æƒ…è§£æä¸åˆ†é•œ", use_container_width=True):
        if not api_key:
            st.error("è¯·é…ç½® API Key")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            
            # ç¬¬ä¸€æ­¥æç¤ºè¯ï¼šé‡ç‚¹åœ¨äºâ€œæ€è€ƒâ€
            STEP1_PROMPT = """ä½ æ˜¯ä¸€ä½æ‹¥æœ‰ 20 å¹´ç»éªŒçš„èµ„æ·±ç”µå½±å¯¼æ¼”å’Œå‰ªè¾‘ä¸“å®¶ã€‚
ä½ çš„ä»»åŠ¡æ˜¯å°†æä¾›çš„è§£è¯´æ–‡æ¡ˆè½¬åŒ–ä¸ºå……æ»¡å™äº‹æ„Ÿå’ŒèŠ‚å¥æ„Ÿçš„åˆ†é•œè„šæœ¬ã€‚

### å¯¼æ¼”æ€è€ƒè·¯å¾„ï¼ˆè¯·æŒ‰æ­¤é€»è¾‘æ‰§è¡Œï¼‰ï¼š
1. **å‰§æƒ…æ·±åº¦åˆ†æ**ï¼šåˆ†ææ–‡æ¡ˆä¸­çš„æ¯ä¸€ä¸ªåœºæ™¯ã€‚å“ªä¸ªæ—¶åˆ»æ˜¯æƒ…ç»ªé«˜æ½®ï¼Ÿå“ªé‡Œæ˜¯ç¯å¢ƒé“ºå«ï¼Ÿå“ªé‡Œæ˜¯åŠ¨ä½œå†²çªï¼Ÿ
2. **ç¡®å®šè§†è§‰èŠ‚å¥**ï¼š
   - å¯¹äºã€åŠ¨ä½œæˆ/å†²çªæ„Ÿã€‘ï¼šåˆ†é•œåº”æ›´å¯†é›†ã€ç®€çŸ­ï¼Œå±•ç°åŠ¨æ€ã€‚
   - å¯¹äºã€æƒ…æ„Ÿæˆ/ç¯å¢ƒæå†™ã€‘ï¼šåˆ†é•œå¯ä»¥ç¨å¾®èˆ’ç¼“ï¼Œä¿æŒæ„å¢ƒã€‚
3. **å¯»æ‰¾é€»è¾‘æ–­ç‚¹**ï¼š
   - å¿…é¡»åœ¨äººç‰©åŠ¨æœºæ”¹å˜ã€è§†è§’å˜åŒ–ã€æˆ–æ˜¯ä¸€ä¸ªå®Œæ•´æ„ç¾¤ç»“æŸæ—¶åˆ‡åˆ†ã€‚
   - å½»åº•æ‰“ç ´åŸæ–‡åŸæœ‰çš„æ®µè½ï¼Œæ ¹æ®ä½ è„‘æµ·ä¸­çš„ç”»é¢è¿åŠ¨æ„Ÿé‡æ–°æ„ç­‘åˆ†é•œã€‚
4. **ç‰©ç†é™åˆ¶ï¼ˆè½¯çº¦æŸï¼‰**ï¼š
   - æ¯ä¸ªåˆ†é•œæ–‡æ¡ˆæ§åˆ¶åœ¨ 20-40 å­—ä¹‹é—´ï¼ˆå¯¹åº” 3.5-5.5 ç§’ï¼‰ã€‚
   - è¿™ä¸æ˜¯æ­»ä»»åŠ¡ï¼Œå¦‚æœä¸€å¥å…³é”®å°è¯å¾ˆæœ‰çˆ†å‘åŠ›ï¼Œå®å¯åˆ†é•œçŸ­ä¸€ç‚¹ï¼ˆ10å­—ï¼‰ä¹Ÿè¦ä¿ä½çˆ†å‘ç‚¹ã€‚
   - ä¸¥ç¦è®©ä¸€ä¸ªåˆ†é•œï¼ˆ5ç§’ï¼‰æ‰¿è½½è¿‡å¤šçš„åŠ¨ä½œä¿¡æ¯ï¼Œå¦‚æœä¸€å¥è¯é‡ŒåŒ…å«äº†ä¸‰ä¸ªä»¥ä¸Šçš„åŠ¨ä½œï¼ˆå¦‚ï¼šæ¨é—¨ã€è¿›å±‹ã€å…³çª—ã€åä¸‹ï¼‰ï¼Œå¿…é¡»æ‹†å¼€ã€‚

### è¾“å‡ºè§„åˆ™ï¼š
- ä¸¥ç¦ä¿®æ”¹åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ã€‚
- ä»…è¾“å‡ºï¼š[åºå·]. [æ–‡æ¡ˆå†…å®¹]
- åœ¨æ¯ä¸€ç»„åˆ†é•œå‰ï¼Œè¯·ç®€å•æ ‡æ³¨ä½ è¿™ä¸€æ®µçš„ã€å¯¼æ¼”æ„å›¾ã€‘ï¼ˆç”¨æ‹¬å·æ³¨æ˜ï¼‰ã€‚

### ç¤ºä¾‹æ ¼å¼ï¼š
1.ï¼ˆå…¨æ™¯å±•ç°å­¤å¯‚æ°›å›´ï¼‰ä»–ä¸€ä¸ªäººé™é™åœ°èµ°åœ¨é›ªåœ°é‡Œï¼ŒåŒ—é£å‘¼å•¸ï¼ŒèƒŒåæ˜¯ç©ºæ— ä¸€äººçš„æ‘è½ã€‚
2.ï¼ˆè¿‘æ™¯ç‰¹å†™åŠ¨ä½œï¼‰ä»–åœä¸‹è„šæ­¥ï¼Œç¼“ç¼“ä½ä¸‹å¤´ï¼Œçœ‹ç€é‚£ä¸²å³å°†è¢«å¤§é›ªè¦†ç›–çš„è„šå°ã€‚
"""

            with st.spinner("å¯¼æ¼”æ­£åœ¨æ·±åº¦é˜…è¯»å‰§æƒ…ï¼Œæ„æ€ç”»é¢èŠ‚å¥..."):
                try:
                    response = client.chat.completions.create(
                        model=model_id,
                        messages=[{"role": "system", "content": STEP1_PROMPT},
                                  {"role": "user", "content": full_story}],
                        temperature=0.5 # æé«˜ä¸€äº›åˆ›é€ åŠ›ï¼Œè®©åˆ†é•œä¸é‚£ä¹ˆæ­»æ¿
                    )
                    st.session_state['storyboard_raw'] = response.choices[0].message.content
                except Exception as e:
                    st.error(f"å¤„ç†å¤±è´¥: {str(e)}")

if st.session_state['storyboard_raw']:
    st.subheader("ğŸ“‹ å¯¼æ¼”åˆ†é•œæ–¹æ¡ˆï¼ˆå«é•œå¤´æ„å›¾åˆ†æï¼‰")
    
    # è§£æå¹¶é¢„è§ˆï¼Œå¢åŠ è§†è§‰è®¡æ•°
    lines = st.session_state['storyboard_raw'].split('\n')
    for line in lines:
        if line.strip():
            # ç®€å•å­—æ•°æ£€æµ‹ä¾›å‚è€ƒ
            text_part = re.sub(r'^\d+[\.ã€\s]+', '', line)
            text_part = re.sub(r'\(.*?\)', '', text_part) # å»æ‰æ„å›¾æ ‡æ³¨
            char_count = len(text_part)
            if char_count > 45: st.error(f"ğŸ”´ å­—æ•°è¾ƒå¤š ({char_count}å­—)ï¼š{line}")
            elif char_count > 0: st.success(f"ğŸŸ¢ åˆ†é•œç¨³å®š ({char_count}å­—)ï¼š{line}")

    st.session_state['storyboard_raw'] = st.text_area("âœï¸ å¯¼æ¼”å¯ä»¥æ‰‹åŠ¨å¾®è°ƒå™äº‹ç‚¹", st.session_state['storyboard_raw'], height=300)

    st.markdown("---")

    # --- ç¬¬äºŒé˜¶æ®µï¼šå…¨è§†è§‰æ‰©å…… ---
    st.header("ç¬¬äºŒæ­¥ï¼šè§†è§‰åŒ–æ‰©å……ï¼ˆMJ å›¾ç‰‡ + å³æ¢¦ AI è§†é¢‘æè¿°ï¼‰")
    
    char_desc = st.text_area("ğŸ‘¤ è§’è‰²åŠç€è£…æ ¸å¿ƒè®¾å®š", 
                             placeholder="ä¾‹ï¼šæ—å‡¡ï¼š25å²ï¼Œç„è‰²åˆºç»£é•¿è¢ï¼Œç›®å…‰å¦‚ç”µï¼Œé»‘è‰²é©¬å°¾ï¼Œæ€§æ ¼éšå¿ã€‚",
                             height=100)
    
    if st.button("ğŸ¨ ç”Ÿæˆå…¨æ–¹ä½è§†è§‰åˆ¶ä½œæç¤ºè¯", use_container_width=True):
        if not char_desc:
            st.error("è¯·å¡«å†™æ ¸å¿ƒè§’è‰²æè¿°ä»¥ä¿æŒè§†è§‰ä¸€è‡´æ€§ã€‚")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            
            STEP2_PROMPT = f"""ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„è§†è§‰æ¦‚å¿µè®¾è®¡å¸ˆå’Œ AI æç¤ºè¯ä¸“å®¶ã€‚
è¯·æ ¹æ®æä¾›çš„ã€åˆ†é•œè„šæœ¬ã€‘ï¼ˆåŒ…å«å¯¼æ¼”æ„å›¾ï¼‰å’Œã€è§’è‰²è®¾å®šã€‘ï¼Œç”Ÿæˆè§†è§‰æŒ‡ä»¤ã€‚

æ ¸å¿ƒè§’è‰²ä¿¡æ¯ï¼š{char_desc}

### å¤„ç†åŸåˆ™ï¼š
1. **è§†è§‰ä¸€è‡´æ€§**ï¼šæ¯ä¸€ä¸ªåˆ†é•œçš„ç”»é¢æè¿°å¿…é¡»åŒ…å«è§’è‰²çš„å…³é”®è§†è§‰ç‰¹å¾ï¼Œç¡®ä¿ Midjourney ç”Ÿæˆçš„äººåƒä¸è·³æˆã€‚
2. **å¯¼æ¼”æ„å›¾è½¬åŒ–**ï¼šæ ¹æ®æ‹¬å·é‡Œçš„å¯¼æ¼”æ„å›¾ï¼ˆå¦‚ï¼šç‰¹å†™ã€å…¨æ™¯ã€ä¿¯ç°ï¼‰ï¼Œåœ¨ç”»é¢æè¿°ä¸­è®¾å®šç›¸åº”çš„æ„å›¾å’Œå…‰å½±ã€‚
3. **åŠ¨æ€è§†é¢‘è®¾è®¡**ï¼šè§†é¢‘æè¿°å¿…é¡»åŸºäºç”»é¢åº•å›¾ï¼Œè®¾è®¡å‡ºç¬¦åˆæ–‡æ¡ˆé€»è¾‘çš„åŠ¨ä½œï¼Œç¡®ä¿ 5 ç§’å†…åŠ¨ä½œæµç•…ã€æœ‰å¼ åŠ›ã€‚

### è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰ï¼š
---
[åºå·]. [æ–‡æ¡ˆå†…å®¹]
ã€ç”»é¢æè¿°ã€‘ï¼š[MJä¸“ç”¨ï¼Œé™æ€åœºæ™¯ã€å…¨é‡è§’è‰²ç‰¹å¾ã€å…‰å½±ç»†èŠ‚ã€æ„å›¾è§†è§’ã€æ°›å›´ã€‚]
ã€è§†é¢‘ç”Ÿæˆã€‘ï¼š[å³æ¢¦/Lumaä¸“ç”¨ï¼Œæè¿°é•œå¤´è¿åŠ¨ã€äººç‰©å…·ä½“çš„ç»†å¾®ç¥æ€å˜åŒ–ã€æ ¸å¿ƒåŠ¨ä½œé€»è¾‘ã€‚]
---"""

            with st.spinner("è§†è§‰è®¾è®¡å¸ˆæ­£åœ¨æ ¹æ®å¯¼æ¼”æ„å›¾ç”Ÿæˆæç¤ºè¯..."):
                try:
                    response = client.chat.completions.create(
                        model=model_id,
                        messages=[{"role": "system", "content": STEP2_PROMPT},
                                  {"role": "user", "content": st.session_state['storyboard_raw']}],
                        temperature=0.4
                    )
                    final_output = response.choices[0].message.content
                    st.subheader("ğŸ¥ æœ€ç»ˆè§†é¢‘åˆ¶ä½œå…¨æµç¨‹è„šæœ¬")
                    st.write(final_output)
                    st.download_button("ğŸ“¥ ä¸‹è½½å®Œæ•´å¯¼æ¼”è„šæœ¬", final_output, file_name="ç”µå½±æ„Ÿåˆ¶ä½œè„šæœ¬.txt")
                except Exception as e:
                    st.error(f"å¤„ç†å¤±è´¥: {str(e)}")

st.markdown("---")
st.caption("AI å¯¼æ¼”ç³»ç»Ÿ v5.0 | å™äº‹ä¸ºæœ¬ï¼ŒæŠ€æœ¯ä¸ºè¾…")
