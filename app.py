import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”åˆ†é•œå¤§å¸ˆ v8.0", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”å·¥ä½œå®¤é…ç½®")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "grok-beta", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é€»è¾‘é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("è¯·è¾“å…¥å…·ä½“çš„ Model ID (å¦‚: grok-3)")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§åˆ†é•œå¤§å¸ˆ v8.0")
st.info("ğŸ’¡ æ ¸å¿ƒåŸåˆ™ï¼šã€ä¸€é•œä¸€æ„ã€‘ã€‚åªè¦æ„æ€å˜äº†ã€åŠ¨ä½œå˜äº†ã€ä¸»è¯­å˜äº†ï¼Œå°±å¿…é¡»æ‹†åˆ†åˆ†é•œï¼Œå³ä¾¿åªæœ‰å‡ ä¸ªå­—ã€‚")

# --- ç¬¬ä¸€é˜¶æ®µï¼šåŸå­åŒ–è§†è§‰åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šå‰§æœ¬åŸå­åŒ–åˆ†é•œï¼ˆç²¾å‡†è§†è§‰åˆ‡åˆ†ï¼‰")

col_left, col_right = st.columns(2)

with col_left:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„åŸå§‹æ–‡æ¡ˆ...")
    
    if st.button("ğŸš€ æ‰§è¡ŒåŸå­åŒ–åˆ†é•œè§„åˆ’"):
        if not api_key or not final_model_id:
            st.error("è¯·å®Œå–„å·¦ä¾§é…ç½®ã€‚")
        elif not raw_script:
            st.warning("æ–‡æ¡ˆä¸ºç©ºã€‚")
        else:
            with st.spinner("å¯¼æ¼”æ­£åœ¨æ‹†è§£è§†è§‰åŸå­ï¼Œè§„åˆ’é•œå¤´èŠ‚å¥..."):
                # å¼ºåŒ–ç‰ˆç¬¬ä¸€æ­¥ Promptï¼šæ ¸å¿ƒæ˜¯â€œä¸€é•œä¸€æ„â€å’Œâ€œç‰©ç†å¯¹é½â€
                step1_prompt = """
ä½ æ˜¯ä¸€åé¡¶çº§æ¼«å‰§å¯¼æ¼”ï¼Œæ“…é•¿ 9:16 ç«–å±çŸ­å‰§ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¯¹æ–‡æ¡ˆè¿›è¡Œã€äºŒæ¬¡ç²¾å‡†åˆ†é•œã€‘ã€‚

ã€ä½ è¦æ‰§è¡Œçš„â€œä¸€é•œä¸€æ„â€åŸåˆ™ã€‘ï¼š
1. **è§†è§‰é‡å¿ƒå•ä¸€åŒ–**ï¼šä¸€ä¸ªåˆ†é•œåªèƒ½è¡¨è¾¾ã€ä¸€ä¸ªã€‘æ ¸å¿ƒåŠ¨ä½œã€æˆ–ã€ä¸€ç§ã€‘æ ¸å¿ƒæƒ…ç»ªã€æˆ–ã€ä¸€å¥ã€‘å®Œæ•´å°è¯ã€‚
2. **ç¦æ­¢å¼ºè¡Œåˆå¹¶**ï¼šå³ä¾¿ä¸¤å¥è¯æ€»å­—æ•°å¾ˆçŸ­ï¼Œå¦‚æœå®ƒä»¬æè¿°çš„æ˜¯ä¸åŒçš„è¡Œä¸ºï¼ˆå¦‚ï¼šä»–è¿›é—¨ã€‚å¥¹æŠ¬å¤´ã€‚ï¼‰ã€æˆ–ä¸åŒçš„æ„æ€ï¼Œã€ä¸¥ç¦ã€‘åˆåœ¨ä¸€ä¸ªåˆ†é•œé‡Œã€‚å› ä¸º Midjourney æ— æ³•åœ¨ä¸€å¼ å›¾ä¸­å‘ˆç°ä¸¤ä¸ªä¸è¿è´¯çš„æ„æ€ã€‚
3. **ç‰©ç†æ—¶é•¿ç¡¬é™åˆ¶**ï¼šæ¯ä¸ªåˆ†é•œæ–‡æ¡ˆã€ç»å¯¹ç¦æ­¢è¶…è¿‡ 35 ä¸ªæ±‰å­—ã€‘ã€‚å¦‚æœä¸€å¥è¯å¤ªé•¿ï¼Œå¿…é¡»å¯»æ‰¾é€»è¾‘æ–­ç‚¹æ‹†åˆ†ä¸ºè¿è´¯çš„ä¸¤ä¸ªåˆ†é•œã€‚
4. **9:16 ç«–å±é€»è¾‘**ï¼šç«–å±ç©ºé—´çª„ï¼Œé€šè¿‡â€œåˆ‡é•œâ€æ¥å¼•å¯¼è§‚ä¼—è§†çº¿æ¯”â€œå¤§å…¨æ™¯â€æ›´æœ‰æ•ˆã€‚

ã€åˆ†é•œæ‹†åˆ†è§¦å‘å™¨ã€‘ï¼š
- ä¸»è¯­åˆ‡æ¢ï¼ˆä»–->å¥¹ï¼‰ã€‚
- åŠ¨ä½œè´¨å˜ï¼ˆç«™ç€->åä¸‹ï¼‰ã€‚
- æƒ…æ„Ÿè½¬æŠ˜ï¼ˆç¬‘->å“­ï¼‰ã€‚
- å°è¯åˆ‡æ¢ï¼ˆAè¯´->Bè¯´ï¼‰ã€‚
- å­—æ•°æ¥è¿‘35å­—ã€‚

ã€åº•çº¿è¦æ±‚ã€‘ï¼š
- ä¸¥ç¦é—æ¼åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ï¼Œä¸¥ç¦æ”¹å˜åŸæ–‡ç»“æ„ï¼Œä¸å‡†æ·»åŠ ä»»ä½•é¢å¤–æè¿°ã€‚
- ä»…è¾“å‡ºï¼šåºå·.æ–‡æ¡ˆ
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.1 # æä½éšæœºæ€§ï¼Œç¡®ä¿é€»è¾‘æ‰§è¡ŒåŠ›
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_output'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œå¤±è´¥ï¼š{str(e)}")

with col_right:
    final_script_v1 = st.text_area("2. åˆ†é•œç»“æœé¢„è§ˆï¼ˆè¯·æ ¸å¯¹ä¸€é•œä¸€æ„åŸåˆ™ï¼‰", 
                                  value=st.session_state.get('step1_output', ''), 
                                  height=400)
    st.caption("ğŸ’¡ å¯¼æ¼”æç¤ºï¼šå¦‚æœå‘ç°æŸä¸€è¡Œæ–‡æ¡ˆåŒ…å«äº†ä¸¤ä¸ªä¸åŒçš„åŠ¨ä½œï¼Œè¯·æ‰‹åŠ¨æŒ‰å›è½¦åˆ‡å¼€å¹¶è¡¥é½åºå·ã€‚")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æŒ‡ä»¤é›†ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æè¿°è¯ç”Ÿæˆ (MJ + å³æ¢¦)")

use_char = st.checkbox("å¼€å¯è§’è‰²ä¸€è‡´æ€§å‚è€ƒè¯", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥æ ¸å¿ƒè§’è‰²è®¾å®šï¼ˆé•¿ç›¸ã€æœé¥°ã€ç‰¹å¾ï¼‰", 
                               placeholder="èµµå°˜ï¼šå†·é…·ï¼Œç„è‰²é”¦è¢...\nå®‰å¦™è¡£ï¼šè‚¤ç™½ï¼Œé“¶ä¸è´è¶ç°ª...", 
                               height=150)

if st.button("ğŸ¨ ç”Ÿæˆå…¨å¥—è§†è§‰æè¿°è¯"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µã€‚")
    else:
        with st.spinner("æ­£åœ¨ä¸ºåŸå­åŒ–åˆ†é•œè®¾è®¡ç”»é¢ä¸åŠ¨æ€..."):
            step2_prompt = f"""
ä½ æ˜¯ä¸€åæ¼«å‰§è§†è§‰æ€»ç›‘ã€‚è¯·ä¸ºä»¥ä¸‹åˆ†é•œç”Ÿæˆ MJ æç¤ºè¯å’Œè§†é¢‘åŠ¨æ€æŒ‡ä»¤ã€‚

ã€æ ¸å¿ƒè§’è‰²å‚è€ƒã€‘ï¼š
{char_detail}

ã€åˆ¶ä½œè§„èŒƒã€‘ï¼š
1. **ç”»é¢æè¿° (MJ)**ï¼š
   - é€‚é… 9:16ã€‚æè¿°é™æ€ç”»é¢ã€‚
   - åŒ…å«ï¼šç¯å¢ƒã€è§’è‰²æ ¸å¿ƒè¯ã€æ™¯åˆ«ï¼ˆç‰¹å†™/ä¸­æ™¯ä¸ºä¸»ï¼‰ã€è§†è§’ã€æ°›å›´ã€‚
   - å¿…é¡»ä½“ç°åˆ†é•œæ–‡æ¡ˆä¸­çš„ã€å”¯ä¸€æ„æ€ã€‘ã€‚
2. **è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)**ï¼š
   - æè¿° 5 ç§’å†…çš„åŠ¨æ€ã€‚
   - ä¸“æ³¨äºåˆ†é•œæ–‡æ¡ˆä¸­çš„ã€æ ¸å¿ƒåŠ¨ä½œã€‘ï¼ˆå¦‚ï¼šçœ¼çœ¶å¾®çº¢ã€æ‰‹æŒ‡é¢¤æŠ–ã€ç¼“ç¼“è½¬å¤´ï¼‰ã€‚
   - é•œå¤´åŠ¨ä½œï¼ˆæ¨/æ‹‰/ç§»ï¼‰ã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼šåœºæ™¯å†…å®¹ï¼Œ[è§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´æè¿°è¯ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼šåŠ¨æ€åŠ¨ä½œæè¿°ï¼Œé•œå¤´è¯­è¨€è½¨è¿¹ï¼Œæƒ…ç»ªèŠ‚å¥æ§åˆ¶
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.4
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=300)
                st.session_state['step2_output'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"æè¿°è¯ç”Ÿæˆå¤±è´¥ï¼š{str(e)}")

if 'step2_output' in st.session_state:
    st.text_area("ğŸ“‹ å¯¼æ¼”ç»ˆç¨¿é¢„è§ˆ", st.session_state['step2_res' if 'step2_res' in st.session_state else 'step2_output'], height=600)
    st.download_button("ğŸ“¥ å¯¼å‡ºåˆ†é•œè„šæœ¬", st.session_state['step2_output'], file_name="æ¼«å‰§åˆ†é•œåŸå­ç‰ˆ.txt")
