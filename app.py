import streamlit as st
from openai import OpenAI
import os

# é¡µé¢é…ç½®
st.set_page_config(page_title="AI æ–‡æ¡ˆè‡ªåŠ¨åˆ†é•œå·¥å…·", layout="wide")

# ä¾§è¾¹æ ï¼šé…ç½®å‚æ•°
st.sidebar.title("âš™ï¸ è®¾ç½®")
api_key = st.sidebar.text_input("è¾“å…¥ API Key", type="password")
base_url = st.sidebar.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")
model_id = st.sidebar.selectbox("é€‰æ‹©æ¨¡å‹ Model ID", [
    "deepseek-chat", 
    "gpt-4o", 
    "claude-3-5-sonnet-20240620", 
    "gemini-1.5-pro",
    "grok-1",
    "doubao-pro-128k"
])

st.title("ğŸ¬ ç”µå½±è§£è¯´æ–‡æ¡ˆè‡ªåŠ¨åˆ†é•œå·¥å…·")
st.info("ä¸Šä¼ TXTæ–‡æ¡ˆï¼ŒAIå°†æ ¹æ®å‰§æƒ…ã€åŠ¨ä½œã€å¯¹è¯è‡ªåŠ¨æ‹†åˆ†ä¸ºé€‚åˆçŸ­è§†é¢‘åˆ¶ä½œçš„åˆ†é•œè„šæœ¬ã€‚")

# ç³»ç»Ÿæç¤ºè¯ï¼ˆPrompt æ³¨å…¥ï¼‰
SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç”µå½±è§£è¯´å·¥ä½œå‘˜ã€‚è¯·å¯¹æä¾›çš„æ–‡æœ¬è¿›è¡Œåˆ†é•œå¤„ç†ã€‚
å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š
1. é€å­—é€å¥ç†è§£å†…å®¹ï¼Œè¿›è¡Œåˆ†æ®µå¤„ç†ã€‚
2. åˆ†é•œé€»è¾‘ï¼šæ¯ä¸ªè§’è‰²å¯¹è¯åˆ‡æ¢ã€åœºæ™¯åˆ‡æ¢ã€åŠ¨ä½œç”»é¢æ”¹å˜ï¼Œå¿…é¡»è®¾ä¸ºä¸‹ä¸€ä¸ªåˆ†é•œã€‚
3. ä¸¥ç¦é—æ¼ï¼šä¸å¯é—æ¼åŸæ–‡ä»»ä½•ä¸€å¥è¯ã€ä¸€ä¸ªå­—ï¼Œä¸èƒ½æ”¹å˜åŸæ–‡æ•…äº‹ç»“æ„ï¼Œç¦æ­¢æ·»åŠ åŸæ–‡ä»¥å¤–çš„å†…å®¹ã€‚
4. ç‰©ç†é™åˆ¶ï¼šæ¯ä¸ªåˆ†é•œæ–‡æ¡ˆä¸èƒ½å¤ªé•¿ã€‚å› ä¸ºä¸€ä¸ªåˆ†é•œåœç•™çº¦5ç§’ï¼Œ35ä¸ªå­—ç¬¦æ¥è¿‘5ç§’ã€‚å› æ­¤ï¼Œå•è¡Œåˆ†é•œæ–‡æ¡ˆä¸¥æ ¼æ§åˆ¶åœ¨35ä¸ªæ±‰å­—ä»¥å†…ã€‚å¦‚æœåŸå¥è¿‡é•¿ï¼Œè¯·åœ¨ä¸æ”¹å˜åŸæ„å’Œæ–‡å­—çš„å‰æä¸‹ï¼Œå°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ªè¿ç»­åˆ†é•œã€‚
5. æ ¼å¼è¦æ±‚ï¼šä½¿ç”¨æ•°å­—ç¼–å·å¼€å¤´ï¼Œæ¯è¡Œä¸€ä¸ªåˆ†é•œã€‚
ä¾‹å¦‚ï¼š
1.8å²é‚£å¹´å®¶é‡Œç©·å¾—æ­ä¸å¼€é”…äº†
2.æ€€å­•çš„æ¯äº²å¸¦ç€æˆ‘åœ¨å¯ºå¤–ä¹è®¨
3.æˆ‘æŠŠåƒ§äººç«¯æ¥çš„ç²¥é¥­å…¨ç»™äº†æ¯äº²
4.æ–½ç²¥çš„å°†å†›åºœè€å¦‡äºº, è®©äººé¢†æˆ‘è¿‡æ¥é—®
5.éƒ½é¥¿æˆäººå¹²äº†æ€ä¹ˆä¸åƒ

è¯·å¼€å§‹å¤„ç†ï¼š"""

# æ–‡ä»¶ä¸Šä¼ 
uploaded_file = st.file_uploader("é€‰æ‹©æœ¬åœ° TXT æ–‡ä»¶", type=['txt'])

if uploaded_file is not None:
    # è¯»å–æ–‡æœ¬å†…å®¹
    stringio = uploaded_file.getvalue().decode("utf-8")
    st.subheader("åŸæ–‡å†…å®¹é¢„è§ˆ")
    st.text_area("åŸå§‹æ–‡æœ¬", stringio, height=200)

    if st.button("ğŸš€ å¼€å§‹ç”Ÿæˆåˆ†é•œ"):
        if not api_key:
            st.error("è¯·å…ˆåœ¨ä¾§è¾¹æ è¾“å…¥ API Key")
        else:
            try:
                # åˆå§‹åŒ–å®¢æˆ·ç«¯
                client = OpenAI(api_key=api_key, base_url=base_url)
                
                with st.spinner('AI æ­£åœ¨åˆ†æå‰§æƒ…å¹¶ç”Ÿæˆåˆ†é•œ...'):
                    response = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": SYSTEM_PROMPT},
                            {"role": "user", "content": stringio}
                        ],
                        temperature=0.3, # é™ä½éšæœºæ€§ï¼Œä¿è¯ä¸¥æ ¼éµå¾ªåŸæ–‡
                    )
                    
                    result = response.choices[0].message.content
                    
                    st.subheader("âœ… ç”Ÿæˆç»“æœ")
                    st.text_area("åˆ†é•œè„šæœ¬ï¼ˆå¯ç›´æ¥å¤åˆ¶ï¼‰", result, height=500)
                    st.download_button("ä¸‹è½½åˆ†é•œè„šæœ¬", result, file_name="åˆ†é•œè„šæœ¬.txt")
                    
            except Exception as e:
                st.error(f"å¤„ç†å¤±è´¥ï¼š{str(e)}")

# ä½¿ç”¨è¯´æ˜
st.markdown("""
---
### ä½¿ç”¨è¯´æ˜ï¼š
1. **API Key**: è¯·ä½¿ç”¨ä½ ä»ä¸­è½¬å¹³å°è·å–çš„ä»¤ç‰Œã€‚
2. **æ¥å£åœ°å€**: é»˜è®¤å·²å¡«å†™ `https://blog.tuiwen.xyz/v1`ã€‚
3. **é€»è¾‘è¯´æ˜**: æ¨¡å‹ä¼šä¸¥æ ¼æŒ‰ç…§35å­—/è¡Œè¿›è¡Œåˆ‡åˆ†ï¼Œç¡®ä¿é…éŸ³æ—¶é•¿ä¸ç”»é¢åŒ¹é…ã€‚
""")
