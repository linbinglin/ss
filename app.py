import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”åˆ†é•œå¤§å¸ˆ Pro v7.0", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”é…ç½®ä¸­å¿ƒ")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("è¯·è¾“å…¥å…·ä½“çš„ Model ID")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§ä¸“ä¸šå¯¼æ¼”çº§åˆ†é•œç³»ç»Ÿ")
st.info("ğŸ’¡ æ ¸å¿ƒæ›´æ–°ï¼šå¼ºåŒ–ã€å°è¯å®Œæ•´æ€§ã€‘é€»è¾‘ã€‚é™¤éå•å¥å°è¯è¶…è¿‡35å­—ï¼Œå¦åˆ™ä¸¥ç¦æ‹†åˆ†äººç‰©çš„ä¸€å¥è¯ã€‚")

# --- ç¬¬ä¸€é˜¶æ®µï¼šå°è¯é©±åŠ¨å‹åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šå‰§æœ¬èŠ‚å¥è§„åˆ’ï¼ˆå¼ºè°ƒå¯¹è¯å®Œæ•´æ€§ï¼‰")

col_left, col_right = st.columns(2)

with col_left:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„åŸå§‹æ–‡æ¡ˆ...")
    
    if st.button("ğŸš€ æ‰§è¡Œç²¾å‡†åˆ†é•œï¼ˆé€»è¾‘ä¼˜åŒ–ï¼‰"):
        if not api_key or not final_model_id:
            st.error("è¯·å®Œå–„é…ç½®ã€‚")
        elif not raw_script:
            st.warning("å†…å®¹ä¸ºç©ºã€‚")
        else:
            with st.spinner("å¯¼æ¼”æ­£åœ¨è¯„ä¼°å°è¯é•¿åº¦ä¸è§†è§‰èŠ‚å¥..."):
                # å¼ºåŒ–ç‰ˆç¬¬ä¸€æ­¥ Promptï¼šæ ¸å¿ƒæ˜¯â€œå°è¯ç»Ÿä¸€â€
                step1_prompt = """
ä½ æ˜¯ä¸€åé¡¶çº§æ¼«å‰§å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯è¿›è¡Œã€äºŒæ¬¡ç²¾å‡†åˆ†é•œã€‘ã€‚

ã€å…³é”®ä¿®æ­£æŒ‡ä»¤ã€‘ï¼š
1. **å¯¹è¯å®Œæ•´æ€§ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**ï¼šäººç‰©è¯´çš„ä¸€å¥å®Œæ•´çš„è¯ã€ä¸€ä¸ªå®Œæ•´çš„å¥å­ï¼ŒåŸåˆ™ä¸Šå¿…é¡»å±äºã€åŒä¸€ä¸ªåˆ†é•œã€‘ã€‚ä¸¥ç¦å°†ä¸€å¥è¯ç”Ÿç¡¬åœ°æ‹†åˆ†æˆä¸Šä¸‹ä¸¤ä¸ªåˆ†é•œã€‚
2. **35å­—é™æ—¶å¹³è¡¡**ï¼š
   - åªæœ‰å½“è¿™ä¸€å¥å°è¯æˆ–è¿™ä¸€æ®µæè¿°ã€ç¡®å®è¶…è¿‡ 35 ä¸ªæ±‰å­—ã€‘æ—¶ï¼Œæ‰å…è®¸è¿›è¡Œæ‹†åˆ†ã€‚
   - æ‹†åˆ†æ—¶ï¼Œå¿…é¡»å¯»æ‰¾è¯­æ°”åœé¡¿ç‚¹ï¼ˆå¦‚é€—å·ã€åˆ†å·ï¼‰ã€‚
3. **è§†è§‰èšåˆ**ï¼š
   - äººç‰©çš„åŠ¨ä½œï¼ˆå¦‚ï¼šä»–å†·ç¬‘ä¸€å£°ï¼‰ä¸å…¶æ¥ä¸‹æ¥çš„å°è¯ï¼ˆå¦‚ï¼šâ€œä½ ä»¥ä¸ºä½ èƒ½è·‘æ‰å—ï¼Ÿâ€ï¼‰å¦‚æœæ€»é•¿å°äº35å­—ï¼Œå¿…é¡»åˆå¹¶ä¸ºä¸€ä¸ªåˆ†é•œã€‚
4. **åˆ†é•œçš„åº¦**ï¼š
   - ä¸è¦ä¸ºäº†åˆ†é•œè€Œåˆ†é•œã€‚è¦ç†è§£åˆ†é•œæ˜¯ä¸ºäº†å‡ºå›¾ã€‚å¦‚æœç”»é¢æ²¡æœ‰å‘ç”Ÿâ€œè§†è§’è½¬æ¢â€ã€â€œåœºæ™¯æ”¹å˜â€æˆ–â€œæƒ…ç»ªè´¨å˜â€ï¼Œä¸”å­—æ•°æœªè¶…æ ‡ï¼Œè¯·ä¿æŒåˆ†é•œçš„å®Œæ•´ã€‚

ã€æ‰§è¡Œé€»è¾‘ã€‘ï¼š
- ç¬¬ä¸€éï¼šé˜…è¯»å…¨æ–‡ï¼Œè¯†åˆ«å‡ºæ¯ä¸€æ®µå¯¹è¯çš„å¼€å§‹å’Œç»“æŸã€‚
- ç¬¬äºŒéï¼šè®¡ç®—æ¯æ®µå¯¹è¯/åŠ¨ä½œçš„å­—æ•°ï¼Œæ‰§è¡Œ 35 å­—é™æ—¶æ ¡éªŒã€‚

ã€è¾“å‡ºè¦æ±‚ã€‘ï¼š
- ä¸¥ç¦é—æ¼åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ï¼Œä¸¥ç¦æ”¹å˜åŸæ–‡ç»“æ„ã€‚
- ä»…è¾“å‡ºï¼šåºå·.æ–‡æ¡ˆ
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.1 # æä½éšæœºæ€§ï¼Œç¡®ä¿é€»è¾‘ä¸¥è°¨
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_output'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œå¤±è´¥ï¼š{str(e)}")

with col_right:
    final_script_v1 = st.text_area("2. åˆ†é•œç»“æœé¢„è§ˆï¼ˆè¯·æ£€æŸ¥å¯¹è¯å®Œæ•´æ€§ï¼‰", 
                                  value=st.session_state.get('step1_output', ''), 
                                  height=400)
    st.caption("ğŸ’¡ å¯¼æ¼”æç¤ºï¼šå¦‚æœå‘ç°äººç‰©çš„ä¸€å¥è¯è¢«åˆ‡æ–­ï¼Œè¯·æ‰‹åŠ¨å°†å…¶åˆå¹¶åˆ°åŒä¸€è¡Œï¼Œå¹¶é‡æ–°æ’å·ã€‚")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æŒ‡ä»¤é›†ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼š9:16 è§†è§‰è¯­è¨€è½¬åŒ–ï¼ˆMJ + å³æ¢¦ï¼‰")

use_char = st.checkbox("å›ºå®šè§’è‰²/ç€è£…å‚è€ƒ", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥æ ¸å¿ƒäººç‰©å¤–è²Œç‰¹å¾ï¼ˆå¿…å¡«ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼‰", 
                               placeholder="èµµå°˜ï¼šå†·é…·ç”·äººï¼Œé»‘å‘æŸå† ï¼Œç„è‰²é”¦è¢...\nå®‰å¦™è¡£ï¼šè‚¤ç™½å¦‚é›ªï¼Œæ­¥æ‘‡å‘é¥°ï¼Œç™½è‰²ç½—è£™...", 
                               height=150)

if st.button("ğŸ¨ ç”Ÿæˆå…¨å¥—è§†è§‰æè¿°è¯"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µã€‚")
    else:
        with st.spinner("æ­£åœ¨æ ¹æ®ç«–å±æ„å›¾è®¾è®¡ç”»é¢ä¸åŠ¨æ€..."):
            step2_prompt = f"""
ä½ æ˜¯ä¸€åæ¼«å‰§è§†è§‰æ€»ç›‘ã€‚è¯·ä¸ºä»¥ä¸‹åˆ†é•œç”Ÿæˆ MJ æç¤ºè¯å’Œè§†é¢‘åŠ¨æ€æŒ‡ä»¤ã€‚

ã€æ ¸å¿ƒè®¾å®šã€‘ï¼š
{char_detail}

ã€è§†è§‰ç”Ÿæˆè§„èŒƒã€‘ï¼š
1. **ç”»é¢æè¿° (MJ)**ï¼š
   - é€‚é… 9:16ã€‚æè¿°é™æ€ç”»é¢ã€‚
   - åŒ…å«ï¼šç¯å¢ƒã€è§’è‰²æ ¸å¿ƒç‰¹å¾è¯ã€æ™¯åˆ«ï¼ˆå¤šç”¨ç‰¹å†™/ä¸­æ™¯ï¼‰ã€è§†è§’ã€æ°›å›´ã€å…‰å½±ã€‚
   - **å¼ºè°ƒ**ï¼šå¦‚æœæ–‡æ¡ˆæ˜¯å°è¯ï¼Œç”»é¢åº”é‡ç‚¹åˆ»ç”»è¯¥è§’è‰²è¯´è¯æ—¶çš„ç¥æ€ï¼ˆå¦‚ï¼šå˜´è§’å¾®æ‰¬ã€ç›®å…‰é˜´å†·ï¼‰ã€‚
2. **è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)**ï¼š
   - æè¿°åŸºäºè¯¥ç”»é¢çš„ 5 ç§’å†…åŠ¨æ€ã€‚
   - å¦‚æœæ˜¯å¯¹è¯åˆ†é•œï¼Œå¿…é¡»æè¿°ï¼šè§’è‰²å£å‹å¼ åˆã€é¢éƒ¨è‚Œè‚‰å¾®åŠ¨ã€çœ¼ç¥é—ªçƒã€‚
   - åŠ å…¥å¾®å°çš„é•œå¤´è¿åŠ¨ã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼šåœºæ™¯å†…å®¹ï¼Œ[è§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´è¯´æ˜ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼šåŠ¨ä½œè¡Œä¸ºï¼Œå£å‹ç¥æ€ï¼Œé•œå¤´è¯­è¨€ï¼Œæƒ…ç»ªèŠ‚å¥
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.4
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=300)
                st.session_state['step2_output'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"æŒ‡ä»¤ç”Ÿæˆå¤±è´¥ï¼š{str(e)}")

if 'step2_output' in st.session_state:
    st.text_area("ğŸ“‹ æœ€ç»ˆæ¼«å‰§å¯¼æ¼”ç¨¿", st.session_state['step2_output'], height=600)
    st.download_button("ğŸ“¥ å¯¼å‡ºåˆ†é•œå…¨æ¡ˆ", st.session_state['step2_output'], file_name="æ¼«å‰§åˆ†é•œå…¨æ¡ˆ_V7.txt")
