import streamlit as st
from openai import OpenAI

st.set_page_config(page_title="å¯¼æ¼”åˆ†é•œä¸“å®¶", layout="wide")

# åˆå§‹åŒ– Session State
if 'step1_result' not in st.session_state:
    st.session_state['step1_result'] = ""

st.sidebar.title("âš™ï¸ é…ç½®")
api_key = st.sidebar.text_input("API Key", type="password")
base_url = st.sidebar.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")
model_id = st.sidebar.selectbox("æ¨¡å‹", ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat"])

st.title("ğŸ¬ ç”µå½±è§£è¯´å…¨æµç¨‹åˆ†é•œå·¥å…·")

# ç¬¬ä¸€é˜¶æ®µï¼šå¼ºåˆ¶æ€§é€»è¾‘é‡ç»„åˆ†é•œ
st.header("ç¬¬ä¸€é˜¶æ®µï¼šé€»è¾‘åˆ†é•œé‡ç»„")
st.info("ğŸ’¡ è¿™é‡Œçš„ç›®æ ‡æ˜¯ï¼šåƒç”µå½±å¯¼æ¼”ä¸€æ ·æ‹†è§£ç”»é¢ï¼Œä½†åƒæ‰“å­—æœºä¸€æ ·ä¿æŒæ–‡å­—åŸæ ·ã€‚")

uploaded_file = st.file_uploader("ä¸Šä¼ æ–‡æ¡ˆ (TXT)", type=['txt'])

if uploaded_file:
    raw_text = uploaded_file.getvalue().decode("utf-8", errors="ignore")
    # å½»åº•æŠ¹é™¤åŸæ–‡çš„æ¢è¡Œï¼Œåˆå¹¶ä¸ºçº¯æ–‡å­—æµï¼Œåˆ‡æ–­ AI å¯¹åŸæ®µè½çš„è®°å¿†
    clean_stream = "".join(raw_text.split())
    
    st.subheader("ğŸ“„ å¾…åˆ†é•œæ–‡å­—æµ")
    st.text_area("ç³»ç»Ÿå·²è‡ªåŠ¨æŠ¹é™¤åŸæ®µè½æ ¼å¼", clean_stream, height=80)

    if st.button("ğŸ”¥ å¼ºåˆ¶é€»è¾‘åˆ†é•œé‡æ„", use_container_width=True):
        client = OpenAI(api_key=api_key, base_url=base_url)
        
        # è¿™é‡Œçš„ Prompt é‡‡ç”¨äº†â€œé‡ç»„â€é€»è¾‘è€Œéâ€œä¿®æ”¹â€é€»è¾‘
        STEP1_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæå…¶ä¸¥è°¨çš„ç”µå½±åˆ†é•œå¸ˆã€‚
ä½ çš„ä»»åŠ¡æ˜¯å°†æä¾›çš„ã€çº¯æ–‡å­—æµã€‘é‡æ–°æ’åˆ—æˆã€åˆ†é•œè„šæœ¬ã€‘ã€‚

### æ ¸å¿ƒæ“ä½œè§„ç¨‹ï¼š
1. **æ·±åº¦å‰§æƒ…è¯»è§£**ï¼šä½ è¦åœ¨è„‘æµ·ä¸­æ¼”ç»ƒè¿™æ®µæ–‡å­—çš„ç”»é¢ã€‚
2. **é€»è¾‘åˆ†é•œï¼ˆä¸¥ç¦å·æ‡’ï¼‰**ï¼š
   - åªè¦å‰§æƒ…ä¸­äººç‰©çš„åŠ¨ä½œå‘ç”Ÿå˜åŒ–ã€åœºæ™¯å‘ç”Ÿè½¬æ¢ã€æˆ–è€…è¯´è¯çš„äººå˜äº†ï¼Œä½ ã€å¿…é¡»ã€‘å¼€å¯ä¸€ä¸ªæ–°åˆ†é•œã€‚
   - ç¦æ­¢ä¿æŒåŸæœ‰çš„æ®µè½ç»“æ„ã€‚ä½ è¦åƒå‰ªè¾‘å¸ˆä¸€æ ·ï¼Œåœ¨æ¯ä¸€ä¸ªè§†è§‰è½¬æŠ˜ç‚¹â€œå‰ªä¸€åˆ€â€ã€‚
3. **ç‰©ç†å­—æ•°å‹åˆ¶**ï¼š
   - ä¸ºäº†é€‚é…5ç§’è§†é¢‘ï¼Œæ¯ä¸€ä¸ªåˆ†é•œçš„æ–‡å­—é•¿åº¦ç»å¯¹ä¸èƒ½è¶…è¿‡35ä¸ªå­—ã€‚
   - å¦‚æœä¸€å¥è¯å¾ˆé•¿ï¼ˆä¾‹å¦‚50ä¸ªå­—ï¼‰ï¼Œä½ å¿…é¡»æ ¹æ®å‘¼å¸æ„Ÿæˆ–è¯­ä¹‰ï¼Œåœ¨ä¸­é—´å¼ºè¡Œåˆ‡æ–­ï¼Œåˆ†æˆä¸¤ä¸ªè¿ç»­çš„åˆ†é•œã€‚
4. **å­—æ•°é›¶æ”¹åŠ¨åè®®**ï¼š
   - ä¸¥ç¦æ·»åŠ ä»»ä½•æè¿°è¯ï¼ˆå¦‚ï¼šåœºæ™¯ã€äººç‰©ã€åŠ¨ä½œè¯´æ˜ï¼‰ã€‚
   - ä½ çš„è¾“å‡ºåªèƒ½åŒ…å«ï¼š[æ•°å­—åºå·] + [åŸæ–‡æ–‡å­—]ã€‚
   - ä¸¥ç¦ä¿®æ”¹ã€åˆ é™¤ã€æ·»åŠ ä»»ä½•ä¸€ä¸ªå­—æˆ–æ ‡ç‚¹ã€‚å¦‚æœæŠŠä½ çš„è¾“å‡ºåˆå¹¶ï¼Œå¿…é¡»ä¸åŸæ–‡å®Œå…¨ä¸€è‡´ã€‚

### æ€è€ƒè¿‡ç¨‹ç¤ºä¾‹ï¼š
åŸæ–‡æµï¼šå¥¹æ¨å¼€é—¨èµ°äº†è¿›å»çœ‹åˆ°æ¡Œå­ä¸Šä¸€ç‰‡ç‹¼è—‰äºæ˜¯å¤§å£°å“­äº†èµ·æ¥
åˆ†é•œåï¼š
1.å¥¹æ¨å¼€é—¨
2.èµ°äº†è¿›å»
3.çœ‹åˆ°æ¡Œå­ä¸Šä¸€ç‰‡ç‹¼è—‰
4.äºæ˜¯å¤§å£°å“­äº†èµ·æ¥
"""
        
        with st.spinner("æ­£åœ¨ç²‰ç¢æ—§æ®µè½ï¼ŒæŒ‰é•œå¤´æ„Ÿé‡æ„ä¸­..."):
            response = client.chat.completions.create(
                model=model_id,
                messages=[
                    {"role": "system", "content": STEP1_PROMPT},
                    {"role": "user", "content": f"è¯·å¯¹ä»¥ä¸‹æ–‡å­—æµè¿›è¡Œé‡ç»„åˆ†é•œï¼š\n\n{clean_stream}"}
                ],
                temperature=0.2 # ç•¥å¾®ç»™ä¸€ç‚¹ç‚¹æ€è€ƒç©ºé—´ï¼Œä½†ä¿æŒç¨³å®š
            )
            st.session_state['step1_result'] = response.choices[0].message.content

# æ˜¾ç¤ºç»“æœ
if st.session_state['step1_result']:
    st.subheader("ğŸ“‹ é‡æ„åçš„åˆ†é•œéª¨æ¶")
    st.session_state['step1_result'] = st.text_area("æ‚¨å¯ä»¥å¾®è°ƒåˆ†é•œçš„åˆ‡åˆ†ç‚¹", st.session_state['step1_result'], height=300)

    st.markdown("---")

    # ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æè¿°
    st.header("ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æ‰©å……")
    char_desc = st.text_area("ğŸ‘¤ è¾“å…¥è§’è‰²ç‰¹å¾æè¿°", placeholder="ä¾‹å¦‚ï¼šæ—å‡¡ï¼š25å²ï¼Œé»‘è‰²å¤è£…ï¼Œæ‰‹æ‹¿é•¿å‰‘ã€‚")

    if st.button("ğŸ¨ ç”Ÿæˆè§†è§‰ä¸è§†é¢‘æŒ‡ä»¤", use_container_width=True):
        client = OpenAI(api_key=api_key, base_url=base_url)
        STEP2_PROMPT = f"""ä½ æ˜¯ä¸€ä¸ªç”µå½±è§†è§‰è®¾è®¡å¸ˆã€‚
è¯·åŸºäºæˆ‘çš„ã€é€»è¾‘åˆ†é•œã€‘å’Œã€è§’è‰²è®¾å®šã€‘ï¼Œä¸ºæ¯ä¸ªåˆ†é•œç”Ÿæˆç”»é¢å’Œè§†é¢‘æè¿°ã€‚

è§’è‰²è®¾å®šï¼š{char_info}

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [åŸæ–‡æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼š[é™æ€ç»†èŠ‚ï¼šåœºæ™¯ã€äººç‰©å¤–è²Œã€æœè£…ã€å…‰å½±ã€‚ä¸¥ç¦åŠ¨ä½œã€‚]
è§†é¢‘ç”Ÿæˆï¼š[åŠ¨æ€ç»†èŠ‚ï¼šäººç‰©å…·ä½“çš„åŠ¨ä½œè¡Œä¸ºã€è¡¨æƒ…å˜åŒ–ã€é•œå¤´è¿åŠ¨ã€‚]
---
"""
        with st.spinner("è®¾è®¡è§†è§‰ä¸­..."):
            # åç»­é€»è¾‘åŒå‰...
            pass
