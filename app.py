import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”åˆ†é•œç³»ç»Ÿ v3.0", layout="wide", page_icon="ğŸ¬")

# ä¾§è¾¹æ 
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”é…ç½®ä¸­å¿ƒ")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    selected_model = st.selectbox("é€‰æ‹©æ¨¡å‹", ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat"])
    
    st.error("ğŸš¨ ç¡¬æ€§è§„åˆ™ï¼šå•é•œå¤´æ–‡æ¡ˆä¸Šé™ 35 å­—ï¼ˆçº¦ 5 ç§’éŸ³é¢‘ï¼‰ã€‚")

st.title("ğŸ¬ æ¼«å‰§å…¨æµç¨‹å¯¼æ¼”åˆ†é•œç³»ç»Ÿ")
st.caption("ç¬¬ä¸€é˜¶æ®µï¼šæ–‡æœ¬ç²¾åˆ†ï¼ˆ35å­—ç¡¬é™ï¼‰ | ç¬¬äºŒé˜¶æ®µï¼šæè¿°è¯ç”Ÿæˆï¼ˆMJ+å³æ¢¦ï¼‰")

# --- ç¬¬ä¸€é˜¶æ®µï¼šç²¾ç»†åˆ†é•œ ---
st.subheader("ç¬¬ä¸€æ­¥ï¼šåŒé‡æ¨ç†ç²¾ç»†åˆ†é•œï¼ˆæ–‡æœ¬æ‹†è§£å±‚ï¼‰")

col_script, col_result = st.columns(2)

with col_script:
    raw_script = st.text_area("è¯·ç²˜è´´åŸå§‹æ–‡æ¡ˆ", height=400)
    
    if st.button("ğŸš€ æ‰§è¡ŒäºŒæ¬¡ç²¾å‡†åˆ†é•œï¼ˆå¼ºåˆ¶35å­—ä¸Šé™ï¼‰"):
        if not api_key or not raw_script:
            st.error("è¯·å®Œå–„é…ç½®ã€‚")
        else:
            with st.spinner("æ­£åœ¨è¿›è¡Œä¸¥æ ¼çš„æ—¶é•¿ä¸èŠ‚å¥æ¨ç†..."):
                # ç¬¬ä¸€é˜¶æ®µ Promptï¼šé‡ç‚¹åœ¨äºâ€œå­—æ•°è­¦å¯Ÿâ€é€»è¾‘
                step1_prompt = """
ä½ æ˜¯ä¸€ä¸ªæå…¶ä¸¥è‹›çš„æ¼«å‰§åˆ†é•œå¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯å¯¹æ–‡æ¡ˆè¿›è¡Œã€äºŒæ¬¡ç²¾å‡†åˆ†é•œã€‘ã€‚
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹ã€æ­»å‘½ä»¤ã€‘ï¼Œå¦åˆ™åˆ†é•œå°†æ— æ³•ä½¿ç”¨ï¼š

ã€æ ¸å¿ƒé™åˆ¶ï¼š35å­—ç”Ÿæ­»çº¿ã€‘
1. **å¼ºåˆ¶æ‹†åˆ†**ï¼šä»»ä½•ä¸€ä¸ªåˆ†é•œçš„æ–‡æ¡ˆå†…å®¹ã€ç»å¯¹ä¸èƒ½è¶…è¿‡ 35 ä¸ªæ±‰å­—ã€‘ã€‚
2. **å¤„ç†é€»è¾‘**ï¼š
   - å¦‚æœä¸€å¥è¯è¶…è¿‡ 35 å­—ï¼Œå¿…é¡»åœ¨æ ‡ç‚¹ç¬¦å·å¤„æ‹†åˆ†ã€‚
   - å¦‚æœä¸€å¥è¯ä¸­é—´æ²¡æœ‰æ ‡ç‚¹ä½†è¶…è¿‡ 35 å­—ï¼Œå¿…é¡»å¼ºè¡Œè¿›è¡Œé€»è¾‘æ–­å¥æ‹†åˆ†ã€‚
   - ä¸€ä¸ªåˆ†é•œé€šå¸¸å¯¹åº” 3-5 ç§’çš„è§†é¢‘ï¼Œè¯·ç¡®ä¿è¯­é€Ÿä¸ç”»é¢åŒ¹é…ã€‚

ã€å…¨å±€åˆ†é•œé€»è¾‘ï¼šåŒé‡æ¨ç†ã€‘
1. **ç¬¬ä¸€éæ¨ç†**ï¼šé˜…è¯»å…¨æ–‡ï¼Œè¯†åˆ«å‰§æƒ…é«˜æ½®ã€è½¬åœºå’Œæƒ…ç»ªç‚¹ã€‚
2. **ç¬¬äºŒéæ¨ç†**ï¼šåœ¨ä¿è¯ 35 å­—ä¸Šé™çš„å‰æä¸‹ï¼Œåˆå¹¶æ„å¢ƒç›¸åŒçš„çŸ­å¥ã€‚
   - ä¸¥ç¦é›¶ç¢ï¼šå¦‚æœè¿ç»­ä¸¤ä¸‰è¡ŒæçŸ­çš„å†…å®¹ï¼ˆå¦‚â€œä»–èµ°äº†ã€‚â€â€œæ¨å¼€é—¨ã€‚â€â€œåœä½äº†ã€‚â€ï¼‰æ€»å’Œå°äº 35 å­—ï¼Œä¸”å±äºåŒä¸€ä¸ªç”»é¢åŠ¨ä½œï¼Œè¯·åˆå¹¶ä¸ºä¸€ä¸ªåˆ†é•œã€‚

ã€åŸåˆ™ã€‘
- ä¸¥ç¦é—æ¼åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ï¼Œä¸¥ç¦ä¿®æ”¹åŸæ–‡ã€‚
- ä¸¥ç¦æ·»åŠ ä»»ä½•æè¿°è¯ã€‚
- ä»…è¾“å‡ºåºå·å’Œæ–‡æ¡ˆã€‚

è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š
1.æ–‡æ¡ˆå†…å®¹ï¼ˆç¡®ä¿æ­¤å¤„å°äº35å­—ï¼‰
2.æ–‡æ¡ˆå†…å®¹ï¼ˆç¡®ä¿æ­¤å¤„å°äº35å­—ï¼‰
"""
                payload = {
                    "model": selected_model,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.0 # å¼ºåˆ¶é™ä½éšæœºæ€§
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload)
                    st.session_state['step1_output'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œå¤±è´¥: {str(e)}")

with col_result:
    # è¿™é‡Œå¢åŠ ä¸€ä¸ªå­—æ•°å®æ—¶æ£€æµ‹åŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿï¼‰
    step1_final = st.text_area("åˆ†é•œç»“æœé¢„è§ˆï¼ˆè¯·æ£€æŸ¥å­—æ•°æ˜¯å¦è¶…æ ‡ï¼‰", 
                                value=st.session_state.get('step1_output', ''), 
                                height=400)
    if step1_final:
        st.info("ğŸ’¡ å»ºè®®ï¼šå¦‚æœçœ‹åˆ°æŸä¸€è¡Œæ–‡å­—ç‰¹åˆ«é•¿ï¼Œè¯·æ‰‹åŠ¨æ•²å›è½¦å¹¶è¡¥ä¸Šåºå·ã€‚")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šæè¿°ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒæ­¥ï¼šç”»é¢ (MJ) ä¸è§†é¢‘ (å³æ¢¦) æè¿°ç”Ÿæˆ")

use_char = st.checkbox("æ˜¯å¦åŠ å…¥è§’è‰²/ç€è£…å‚è€ƒ", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥è§’è‰²è¯¦ç»†ç‰¹å¾ï¼ˆé•¿ç›¸ã€å‘é¥°ã€è¡£æœï¼‰", height=150, placeholder="ä¾‹å¦‚ï¼šèµµå°˜ï¼Œç„è‰²é”¦è¢...å®‰å¦™è¡£ï¼Œé“¶ä¸è´è¶å ç ç°ª...")

if st.button("ğŸ¨ ç”Ÿæˆå…¨å¥—æè¿°è¯"):
    if not step1_final:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€æ­¥ã€‚")
    else:
        with st.spinner("æ­£åœ¨æ„å»º 9:16 è§†è§‰æ–¹æ¡ˆ..."):
            step2_prompt = f"""
ä½ æ˜¯ä¸€ä¸ªæ¼«å‰§åŸç”»å¯¼æ¼”ã€‚è¯·ä¸ºæ¯ä¸€ä¸ªåˆ†é•œç”Ÿæˆé€‚é… 9:16 æ¯”ä¾‹çš„ MJ æç¤ºè¯å’Œå³æ¢¦ AI è§†é¢‘æŒ‡ä»¤ã€‚

ã€è§’è‰²ä¸€è‡´æ€§æ ¸å¿ƒè®¾å®šã€‘ï¼š
{char_detail}

ã€ç”ŸæˆæŒ‡å—ã€‘ï¼š
1. **ç”»é¢æè¿° (Midjourney)**ï¼š
   - å¿…é¡»åŒ…å«ï¼š9:16 æ¯”ä¾‹ã€å›ºå®šåœºæ™¯æè¿°ã€å›ºå®šçš„è§’è‰²å¤–è²Œç€è£…ã€ç‰¹å®šæ™¯åˆ«ï¼ˆç‰¹å†™/ä¸­æ™¯ï¼‰ã€å…‰å½±æ°›å›´ã€‚
   - **ç¦æ­¢å‡ºç°ä»»ä½•åŠ¨è¯**ï¼Œåªæè¿°é™æ€ã€‚
2. **è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)**ï¼š
   - å¿…é¡»æè¿°ï¼šåŸºäºç”»é¢çš„åŠ¨æ€æ¼”å˜ï¼ˆå¦‚ï¼šè§’è‰²çœ¼ç¥ä»å“€ä¼¤å˜ä¸ºæ„¤æ€’ã€è£™æ‘†é£˜åŠ¨ã€æ‰‹ç¼“ç¼“æŠ¬èµ·ï¼‰ã€‚
   - é•œå¤´è¯­è¨€ï¼šæ¨æ‹‰ã€æ‘‡ç§»ã€è·Ÿæ‹ã€‚
   - **æ—¶é—´æ§åˆ¶**ï¼šæ‰€æœ‰åŠ¨æ€å¿…é¡»èƒ½åœ¨ 5 ç§’å†…å®Œç¾å‘ˆç°ã€‚

ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
åºå·. [åˆ†é•œæ–‡æ¡ˆå†…å®¹]
ç”»é¢æè¿°ï¼šåœºæ™¯å†…å®¹ï¼Œ[è§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´æè¿°ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼šåŠ¨æ€è¡Œä¸ºæè¿°ï¼Œé•œå¤´è¿åŠ¨æŒ‡ä»¤ï¼Œæƒ…ç»ªèŠ‚å¥æ§åˆ¶
"""
            payload = {
                "model": selected_model,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": step1_final}
                ],
                "temperature": 0.4
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload)
                st.session_state['step2_output'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"ç”Ÿæˆå¤±è´¥: {str(e)}")

if 'step2_output' in st.session_state:
    st.text_area("æœ€ç»ˆåˆ†é•œè¡¨ç»“æœ", st.session_state['step2_output'], height=500)
    st.download_button("ğŸ“¥ å¯¼å‡ºåˆ†é•œæ–‡ä»¶", st.session_state['step2_output'], file_name="ç²¾å‡†åˆ†é•œè„šæœ¬.txt")
