import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”åˆ†é•œå¤§å¸ˆ v14.0", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”å·¥ä½œå®¤é…ç½®")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "grok-beta", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é€»è¾‘é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("è¯·è¾“å…¥å…·ä½“çš„ Model ID (å¿…å¡«)")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§åˆ†é•œå¤§å¸ˆ v14.0")
st.error("ğŸš¨ è­¦å‘Šï¼šä¸¥ç¦æ²¿ç”¨åŸæ–‡æ®µè½ï¼å¿…é¡»æŒ‰ã€è§†è§‰ç¬é—´ã€‘å’Œã€35å­—é™åˆ¶ã€‘é‡æ–°ç‹¬ç«‹åˆ†é•œï¼Œä¸¥ç¦ä¸¢å­—ï¼")

# --- ç¬¬ä¸€é˜¶æ®µï¼šç²‰ç¢æ€§ç²¾ç»†åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šè§†è§‰åŸå­åŒ–é‡æ„åˆ†é•œï¼ˆæ‰“ç ´æ®µè½ä¾èµ–ï¼‰")

col_script, col_board = st.columns(2)

with col_script:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="åœ¨æ­¤è¾“å…¥å‰§æœ¬æ–‡æ¡ˆ...")
    
    if st.button("ğŸš€ å¼€å§‹çµé­‚åˆ†é•œé‡æ„"):
        if not api_key or not final_model_id:
            st.error("è¯·å®Œå–„å·¦ä¾§ API é…ç½®å’Œæ¨¡å‹ IDã€‚")
        elif not raw_script:
            st.warning("å†…å®¹ä¸ºç©ºã€‚")
        else:
            with st.spinner("æ­£åœ¨ç²‰ç¢æ®µè½ç»“æ„ï¼ŒåŸºäºè§†è§‰é€»è¾‘é‡æ–°æ‹‰ç‰‡..."):
                # v14.0 æè‡´æŒ‡ä»¤ï¼šå¼ºåˆ¶æ‰“ç ´æ®µè½æƒ¯æ€§
                step1_prompt = """
ä½ ç°åœ¨æ˜¯ä¸€ä¸ªé¡¶çº§çš„ç«–å±æ¼«å‰§ï¼ˆ9:16ï¼‰åˆ†é•œå¯¼æ¼”ã€‚
ä½ çš„ä»»åŠ¡æ˜¯å°†æä¾›çš„æ–‡æ¡ˆï¼ŒæŒ‰ç…§ã€è§†è§‰åŸå­ã€‘å’Œã€5ç§’éŸ³é¢‘æ­¥é•¿ã€‘é‡æ–°åˆ‡å‰²ã€‚

ã€ç¬¬ä¸€æ­¥ï¼šå½»åº•ç²‰ç¢ç»“æ„ã€‘
- å¿½ç•¥åŸæ–‡çš„æ‰€æœ‰æ¢è¡Œå’Œåˆ†æ®µã€‚
- ä¸¥ç¦ç›´æ¥æŒ‰ç…§åŸæ–‡çš„æ®µè½è¿›è¡Œåˆ†é•œã€‚åŸæ–‡çš„æ®µè½åˆ’åˆ†æ˜¯æ— å‚è€ƒä»·å€¼çš„ã€‚

ã€ç¬¬äºŒæ­¥ï¼šè§†è§‰åŸå­åŒ–åˆ†é•œé€»è¾‘ã€‘
- **ä¸€é•œä¸€ç”»**ï¼šä¸€ä¸ªåˆ†é•œåªèƒ½ä»£è¡¨ä¸€ä¸ªã€é™æ­¢çš„è§†è§‰ç¬é—´ã€‘ã€‚
- **åŠ¨ä½œæ‹†åˆ†**ï¼šå¦‚æœä¸€å¥è¯é‡ŒåŒ…å«ä¸¤ä¸ªåŠ¨ä½œï¼ˆå¦‚ï¼šä»–æ¨é—¨è¿›æ¥ï¼Œåˆåä¸‹äº†ï¼‰ï¼Œå¿…é¡»æ‹†åˆ†ä¸ºä¸¤ä¸ªåˆ†é•œã€‚ä¸€å¼  MJ å›¾ç”»ä¸å‡ºä¸¤ä¸ªè¿ç»­åŠ¨ä½œã€‚
- **å¯¹è¯æ‹†åˆ†**ï¼šæ¯ä¸€å¥ä¸åŒè§’è‰²çš„å¯¹ç™½ã€ç”šè‡³åŒä¸€è§’è‰²çš„é•¿éš¾å¥ï¼Œå¿…é¡»ç‹¬ç«‹æˆé•œã€‚
- **35å­—ç‰©ç†çº¢çº¿**ï¼šæ¯ä¸ªåˆ†é•œæ–‡æ¡ˆã€ç»å¯¹ç¦æ­¢è¶…è¿‡ 35 ä¸ªæ±‰å­—ã€‘ï¼ˆå¯¹åº”5ç§’éŸ³é¢‘ï¼‰ã€‚å“ªæ€•æ˜¯ä¸€å¥é•¿å¯¹ç™½ï¼Œä¹Ÿå¿…é¡»åœ¨è¯­æ°”åœé¡¿å¤„å¼ºè¡Œåˆ‡å¼€ï¼

ã€ç¬¬ä¸‰æ­¥ï¼šæ•°æ®æ— æŸæ ¡éªŒã€‘
- ä½ å¿…é¡»æŒ‰ç…§é¡ºåºæå–åŸæ–‡çš„æ‰€æœ‰å­—ç¬¦ã€‚
- **ä¸¥ç¦é—æ¼åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ï¼Œä¸¥ç¦ä¿®æ”¹åŸæ–‡ç»“æ„ï¼Œä¸¥ç¦æ·»åŠ ä»»ä½•æè¿°è¯ã€‚**

è¾“å‡ºè¦æ±‚ï¼š
ä»…è¾“å‡ºåºå·å’Œæ–‡æ¡ˆã€‚ä¾‹å¦‚ï¼š
1.å†…å®¹...
2.å†…å®¹...
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.0 # å¼ºåˆ¶é›¶éšæœºæ€§ï¼Œç¡®ä¿ä¸ä¸¢å­—
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_res'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œè§„åˆ’å¤±è´¥ï¼š{str(e)}")

with col_board:
    final_script_v1 = st.text_area("2. å¯¼æ¼”ç²¾ä¿®åˆ†é•œï¼ˆæ¯ä¸€è¡Œåº”ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç”»é¢ç¬é—´ï¼‰", 
                                  value=st.session_state.get('step1_res', ''), 
                                  height=400)
    st.caption("ğŸ’¡ æç¤ºï¼šæ‰«è§†å³ä¾§ã€‚å¦‚æœæŸä¸€è¡Œæ–‡æ¡ˆåŒ…å«äº†â€œå…ˆåšä»€ä¹ˆå†åšä»€ä¹ˆâ€ï¼Œè¯·æ‰‹åŠ¨å›è½¦åˆ‡å¼€ã€‚")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æŒ‡ä»¤é›†ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼š9:16 è§†è§‰è¯­è¨€è½¬åŒ–ï¼ˆMJ + å³æ¢¦ï¼‰")

use_char = st.checkbox("å›ºå®šè§’è‰²/ç€è£…è®¾å®šï¼ˆé˜²æ­¢äººç‰©è·³æˆï¼‰", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥æ ¸å¿ƒäººç‰©å¤–è²Œç‰¹å¾ï¼ˆMidjourney ä¸€è‡´æ€§å…³é”®ï¼‰", 
                               placeholder="èµµå°˜ï¼šå†·é…·ç”·äººï¼Œé»‘å‘æŸå† ï¼Œç„è‰²é”¦è¢...\nå®‰å¦™è¡£ï¼šè‚¤ç™½ï¼Œæ­¥æ‘‡å‘é¥°ï¼Œç™½è‰²ç½—è£™...", 
                               height=150)

if st.button("ğŸ¨ ç”Ÿæˆå…¨å¥—è§†è§‰æç¤ºè¯"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µã€‚")
    else:
        with st.spinner("æ­£åœ¨æ„æ€ 9:16 ç«–å±æ„å›¾ä¸ 5 ç§’åŠ¨æ€æè¿°..."):
            step2_prompt = f"""
ä½ æ˜¯ä¸€åèµ„æ·±æ¼«å‰§è§†è§‰æ€»ç›‘ã€‚è¯·ä¸ºä»¥ä¸‹åˆ†é•œç”Ÿæˆ MJ æç¤ºè¯å’Œè§†é¢‘åŠ¨æ€æŒ‡ä»¤ã€‚

ã€æ ¸å¿ƒè§’è‰²å‚è€ƒæ¡£æ¡ˆã€‘ï¼š
{char_detail}

ã€è§†è§‰è¡¨ç°è§„èŒƒã€‘ï¼š
1. **ç”»é¢æè¿° (MJ)**ï¼š
   - é€‚é… 9:16ã€‚æè¿°é™æ€ç”»é¢ï¼ˆåœºæ™¯ç¯å¢ƒã€è§’è‰²è®¾å®šè¯ã€æ™¯åˆ«è§†è§’ã€æ°›å›´ï¼‰ã€‚
   - **æ™¯åˆ«æ§åˆ¶**ï¼šæ ¹æ®æ–‡æ¡ˆã€‚å°è¯ç”¨ç‰¹å†™/ä¸­æ™¯ï¼›å¤§åŠ¨ä½œæˆ–è½¬åœºç”¨å…¨æ™¯ã€‚
   - **ç¦æ­¢å‡ºç°åŠ¨è¯**ï¼Œå¿…é¡»æè¿°ä¸€ä¸ªé™æ­¢çš„â€œåŸå­ç¬é—´â€ã€‚
2. **è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)**ï¼š
   - æè¿°åŸºäºé™æ€å›¾çš„ 5 ç§’å†…åŠ¨æ€ã€‚
   - åŒ…å«ï¼šè§’è‰²åŠ¨ä½œç»†èŠ‚ï¼ˆå¦‚è½¬å¤´ã€å‚çœ¼ï¼‰ã€é•œå¤´è¯­è¨€ï¼ˆæ¨æ‹‰æ‘‡ç§»ï¼‰ã€‚
   - æ‰€æœ‰åŠ¨æ€åŠ¨ä½œå¿…é¡»åœ¨ 5 ç§’éŸ³é¢‘æ—¶é—´å†…èƒ½è‡ªç„¶å®Œæˆã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼šåœºæ™¯å†…å®¹ï¼Œ[è§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´æè¿°è¯ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼šå…·ä½“åŠ¨æ€åŠ¨ä½œæè¿°ï¼Œé•œå¤´è¿åŠ¨è½¨è¿¹ï¼Œæƒ…ç»ªèŠ‚å¥
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.4
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=300)
                st.session_state['step2_res'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"æç¤ºè¯ç”Ÿæˆå¤±è´¥ï¼š{str(e)}")

if 'step2_res' in st.session_state:
    st.subheader("ğŸ“‹ æœ€ç»ˆå¯¼æ¼”åˆ†é•œç¨¿")
    st.text_area("é¢„è§ˆç»“æœ", st.session_state['step2_res'], height=600)
    st.download_button("ğŸ“¥ ä¸‹è½½å®Œæ•´åˆ†é•œå…¨æ¡ˆ", st.session_state['step2_res'], file_name="æ¼«å‰§åˆ†é•œå¯¼æ¼”å…¨æ¡ˆ.txt")
