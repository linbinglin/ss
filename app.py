import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å…¨æµç¨‹å¯¼æ¼”ç³»ç»Ÿ v11.0", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ ï¼šAPI ä¸è‡ªå®šä¹‰æ¨¡å‹é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”å·¥ä½œå®¤é…ç½®")
    base_url = st.text_input("ä¸­è½¬æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "grok-beta", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é€»è¾‘é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("è¯·è¾“å…¥å…·ä½“çš„ Model ID")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§å…¨æµç¨‹åˆ†é•œç³»ç»Ÿ v11.0")
st.info("ğŸ’¡ æ ¸å¿ƒç†å¿µï¼šè§†è§‰å™äº‹ä¼˜å…ˆã€‚AI éœ€å…ˆç†è§£æ–‡æ¡ˆæƒ…æ„Ÿä¸ç”»é¢ï¼Œå†ä»¥ 35 å­—é™æ—¶ä½œä¸ºè¾…åŠ©çº¢çº¿ã€‚")

# --- ç¬¬ä¸€é˜¶æ®µï¼šå‰§æœ¬çµé­‚åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šå¯¼æ¼”çº§ç²¾ç»†åˆ†é•œï¼ˆè§†è§‰æ„æ€é©±åŠ¨ï¼‰")

col_script, col_board = st.columns(2)

with col_script:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="åœ¨æ­¤è¾“å…¥å‰§æœ¬æ–‡æ¡ˆ...")
    
    if st.button("ğŸš€ æ‰§è¡Œå¯¼æ¼”çº§çµé­‚åˆ†é•œ"):
        if not api_key or not final_model_id:
            st.error("è¯·å®Œå–„é…ç½®ä¿¡æ¯ã€‚")
        elif not raw_script:
            st.warning("æ–‡æ¡ˆä¸ºç©ºã€‚")
        else:
            with st.spinner("å¯¼æ¼”æ­£åœ¨æ·±åº¦é˜…è¯»ã€æ€è€ƒç”»é¢å¹¶è§„åˆ’åˆ†é•œ..."):
                # v11.0 é‡å¡‘æŒ‡ä»¤ï¼šå¼ºè°ƒè§†è§‰ç†è§£
                step1_prompt = """
ä½ æ˜¯ä¸€åé¡¶çº§æ¼«å‰§å‰ªè¾‘å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æ–‡æ¡ˆè¿›è¡Œã€äºŒæ¬¡ç²¾å‡†åˆ†é•œã€‘ã€‚

ã€ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šè§†è§‰å™äº‹ç†è§£ã€‘
1. **ç†è§£æ„å¢ƒ**ï¼šè®¤çœŸé˜…è¯»å…¨æ–‡ï¼Œç†è§£æ•…äº‹èƒŒæ™¯ã€äººç‰©æƒ…ç»ªã€åœºæ™¯è½¬æ¢ã€‚
2. **å®šä¹‰é•œå¤´å•ä½**ï¼šä¸€ä¸ªåˆ†é•œä»£è¡¨ä¸€ä¸ªâ€œè§†è§‰åŠ¨ä½œâ€æˆ–â€œæƒ…ç»ªç„¦ç‚¹â€ã€‚
   - å½“è§†è§‰é‡å¿ƒå‘ç”Ÿè½¬ç§»ï¼ˆå¦‚ï¼šä»çœ‹é—¨å¤–è½¬åˆ°çœ‹é—¨å†…ï¼‰ã€ä¸»è¯­åˆ‡æ¢ã€æˆ–åŠ¨ä½œæ€§è´¨æ”¹å˜æ—¶ï¼Œå°±æ˜¯ä¸€ä¸ªåˆ†é•œç‚¹ã€‚
   - ä¸¥ç¦ç”Ÿç¡¬åˆ†é•œã€‚å¦‚æœæ˜¯åŒä¸€ä¸ªåŠ¨ä½œæˆ–åŒä¸€å¥å°è¯ï¼Œå³ä½¿æ–‡æ¡ˆç¨é•¿ï¼Œä¹Ÿè¦å°½é‡ä¿æŒè§†è§‰çš„å®Œæ•´ã€‚

ã€ç¬¬äºŒä¼˜å…ˆçº§ï¼šç‰©ç†æ—¶é•¿çº¢çº¿ã€‘
1. **éŸ³é¢‘/è§†é¢‘å¯¹é½**ï¼šä¸ºäº†é€‚é…å³æ¢¦AIç”Ÿæˆçš„5ç§’è§†é¢‘ï¼Œå•åˆ†é•œæ–‡æ¡ˆã€ä¸Šé™ä¸º 35 ä¸ªæ±‰å­—ã€‘ã€‚
2. **æ™ºèƒ½åˆ‡å‰²**ï¼šå¦‚æœä¸€ä¸ªè§†è§‰å•å…ƒï¼ˆå¦‚ä¸€é•¿æ®µå°è¯ï¼‰è¶…è¿‡äº†35å­—ï¼Œä¸è¦æ­»æ¿åˆ‡å‰²ï¼Œè¯·å¯»æ‰¾æ–‡å­—ä¸­çš„â€œå‘¼å¸æ„Ÿæ–­å¥å¤„â€æˆ–â€œæƒ…ç»ªåœé¡¿ç‚¹â€è¿›è¡ŒäºŒæ¬¡ç»†åˆ†ã€‚

ã€æ ¸å¿ƒåº•çº¿ã€‘
- **æ— æŸè¿˜åŸ**ï¼šå¿…é¡»ä¿ç•™åŸæ–‡æ¯ä¸€ä¸ªå­—ï¼Œä¸€ä¸ªéƒ½ä¸èƒ½å°‘ã€‚ä¸¥ç¦æ·»åŠ ã€é—æ¼æˆ–æ€»ç»“ã€‚
- **ç»“æ„å¿ è¯š**ï¼šä¸æ”¹å˜æ•…äº‹é¡ºåºã€‚

è¾“å‡ºè¦æ±‚ï¼š
ä»…è¾“å‡ºå¸¦åºå·çš„åˆ†é•œåˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š
1.å†…å®¹...
2.å†…å®¹...
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.4 # æå‡æ¸©åº¦ï¼Œå¢å¼ºå¯¹æ–‡å­¦æ„å¢ƒçš„ç†è§£åŠ›
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_res'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œè§„åˆ’å¤±è´¥ï¼š{str(e)}")

with col_board:
    final_script_v1 = st.text_area("2. å¯¼æ¼”å»ºè®®åˆ†é•œï¼ˆè¯·æ£€æŸ¥è§†è§‰åˆç†æ€§ï¼‰", 
                                  value=st.session_state.get('step1_res', ''), 
                                  height=400)
    st.caption("æ£€æŸ¥ï¼šç¡®è®¤æ¯ä¸ªåˆ†é•œæ˜¯å¦è¡¨è¾¾äº†ä¸€ä¸ªå®Œæ•´çš„åŠ¨ä½œæˆ–å°è¯ï¼Œä¸”è¯»å®Œçº¦5ç§’å†…ã€‚")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æŒ‡ä»¤é›†ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰è¯­è¨€è½¬åŒ–ï¼ˆMJ + å³æ¢¦ï¼‰")

use_char = st.checkbox("æ³¨å…¥è§’è‰²å¤–è²Œ/ç€è£…ä¸€è‡´æ€§è®¾å®š", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥æ ¸å¿ƒäººç‰©å¤–è²Œç‰¹å¾ï¼ˆå¦‚ï¼šé»‘å‘æŸå† ï¼Œç„è‰²é”¦è¢...ï¼‰", height=150)

if st.button("ğŸ¨ ç”Ÿæˆè§†è§‰å…¨æ¡ˆï¼ˆæç¤ºè¯ï¼‰"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µã€‚")
    else:
        with st.spinner("æ­£åœ¨æ„æ€ 9:16 è§†è§‰æ„å›¾ä¸åŠ¨æ€æè¿°..."):
            step2_prompt = f"""
ä½ æ˜¯ä¸€åèµ„æ·±æ¼«å‰§è§†è§‰æ€»ç›‘ã€‚è¯·æ ¹æ®åˆ†é•œå†…å®¹ç”Ÿæˆ Midjourney æç¤ºè¯å’Œè§†é¢‘åŠ¨æ€æŒ‡ä»¤ã€‚

ã€æ ¸å¿ƒè§’è‰²å‚è€ƒã€‘ï¼š
{char_detail}

ã€è§†è§‰è¡¨ç°è§„èŒƒã€‘ï¼š
1. **ç”»é¢æè¿° (MJ)**ï¼š
   - é€‚é… 9:16ã€‚æè¿°é™æ€ç”»é¢ï¼ˆåœºæ™¯ç¯å¢ƒã€è§’è‰²å¤–è²Œã€ç€è£…ã€ç¥æ€ã€å…‰å½±ï¼‰ã€‚
   - **æ™¯åˆ«é€»è¾‘**ï¼šæ ¹æ®æ–‡æ¡ˆæƒ…ç»ªé€‰æ‹©æ™¯åˆ«ã€‚å°è¯æˆ–å¿ƒç†æ´»åŠ¨å¤šç”¨ç‰¹å†™/ä¸­æ™¯ï¼›ç¯å¢ƒæè¿°ç”¨è¿œæ™¯ã€‚
   - ç¦æ­¢æè¿°åŠ¨è¯ã€‚
2. **è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)**ï¼š
   - åŸºäº MJ é™æ€å›¾çš„ 5 ç§’å†…åŠ¨æ€æ¼”å˜ã€‚
   - æè¿°ï¼šåŠ¨ä½œç»†èŠ‚ï¼ˆå¦‚æ‰‹æŒ‡é¢¤åŠ¨ã€çœ¼ç«æ¯›é—ªçƒã€è§’è‰²ç¼“ç¼“è½¬å¤´ï¼‰ã€é•œå¤´è¯­è¨€ï¼ˆå¦‚æ¨è¿‘ã€è·Ÿæ‹ï¼‰ã€‚
   - åŠ¨ä½œå¿…é¡»ä¸æ–‡æ¡ˆæƒ…æ„Ÿå®Œå…¨å¥‘åˆã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆå†…å®¹]
ç”»é¢æè¿°ï¼šåœºæ™¯å†…å®¹ï¼Œ[è§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´æè¿°è¯ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼šåŠ¨æ€åŠ¨ä½œè½¨è¿¹ï¼Œé•œå¤´è¿åŠ¨æŒ‡ä»¤ï¼Œæƒ…ç»ªèŠ‚å¥
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.5
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=300)
                st.session_state['step2_res'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"ç”Ÿæˆæç¤ºè¯å¤±è´¥ï¼š{str(e)}")

if 'step2_res' in st.session_state:
    st.text_area("ğŸ“‹ æœ€ç»ˆå¯¼æ¼”åˆ†é•œå…¨æ¡ˆ", st.session_state['step2_res'], height=600)
    st.download_button("ğŸ“¥ å¯¼å‡ºåˆ†é•œæ–‡ä»¶", st.session_state['step2_res'], file_name="æ¼«å‰§åˆ†é•œå¯¼æ¼”ç¨¿.txt")
