import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”åˆ†é•œå¤§å¸ˆ Pro", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ ï¼šAPI ä¸æ¨¡å‹é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”å·¥ä½œå®¤é…ç½®")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é€»è¾‘é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("è¯·è¾“å…¥å…·ä½“ Model ID")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§å…¨æµç¨‹åˆ†é•œç³»ç»Ÿ")
st.info("ğŸ’¡ æ ¸å¿ƒç†å¿µï¼šåˆ†é•œæ˜¯è§†è§‰èŠ‚å¥çš„è·³åŠ¨ã€‚ä¸€ä¸ªåˆ†é•œå°±æ˜¯ä¸€ä¸ªè§†è§‰å‘¼å¸æ„Ÿã€‚")

# --- ç¬¬ä¸€é˜¶æ®µï¼šå¯¼æ¼”æ€ç»´æ–‡æœ¬åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šå‰§æœ¬èŠ‚å¥è§„åˆ’ï¼ˆæ–‡æœ¬åˆ†é•œï¼‰")

col_script, col_board = st.columns(2)

with col_script:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="è¯·è¾“å…¥å®Œæ•´æ–‡æ¡ˆ...")
    
    if st.button("ğŸš€ å¼€å§‹è‰ºæœ¯æ€§åˆ†é•œè§„åˆ’"):
        if not api_key or not final_model_id:
            st.error("è¯·é…ç½® API ä¿¡æ¯å’Œæ¨¡å‹ã€‚")
        elif not raw_script:
            st.warning("å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚")
        else:
            with st.spinner("å¯¼æ¼”æ­£åœ¨æ„æ€ç”»é¢èŠ‚å¥..."):
                # æ ¸å¿ƒ Promptï¼šä¸å†æ­»æ¿ï¼Œå¼ºè°ƒâ€œæ„ä¹‰â€
                step1_prompt = """
ä½ æ˜¯ä¸€åèµ„æ·±çš„æ¼«å‰§å‰ªè¾‘å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æ–‡æ¡ˆè¿›è¡Œã€äºŒæ¬¡ç²¾å‡†åˆ†é•œã€‘ã€‚

ã€ä½ è¦ç†è§£åˆ†é•œçš„æ„ä¹‰ã€‘ï¼š
1. **åˆ†é•œä¸æ˜¯æ®µè½åˆ†å‰²**ï¼šä¸€ä¸ªåˆ†é•œä»£è¡¨ä¸€ä¸ªâ€œè§†è§‰èŠ‚å¥ç‚¹â€ã€‚
2. **å¤ªç¢çš„åæœ**ï¼šåˆ†é•œå¤ªå¤šä¼šå¯¼è‡´äººç‰©åœ¨Midjourneyä¸­é¢‘ç¹â€œå˜è„¸â€ï¼Œåœºæ™¯èƒŒæ™¯é—ªçƒï¼Œè§‚ä¼—äº§ç”Ÿè§†è§‰ç–²åŠ³ã€‚
3. **å¤ªå°‘çš„åæœ**ï¼šè§†é¢‘ç”Ÿæˆï¼ˆå³æ¢¦AIï¼‰åªèƒ½ç”Ÿæˆ5ç§’å·¦å³ã€‚å¦‚æœåˆ†é•œå¤ªé•¿ï¼ˆæ–‡æ¡ˆè¯»å®Œè¦10ç§’ï¼‰ï¼Œç”»é¢ä¼šåœæ»ï¼Œäº§ç”Ÿä¸¥é‡çš„å‰²è£‚æ„Ÿã€‚
4. **ç†æƒ³çŠ¶æ€**ï¼šä¸€ä¸ªåˆ†é•œåº”åŒ…å«ä¸€ä¸ªå®Œæ•´çš„â€œåŠ¨ä½œâ€æˆ–â€œæƒ…ç»ªè¡¨è¾¾â€ã€‚

ã€åˆ†é•œé€»è¾‘æŒ‡å¯¼ã€‘ï¼š
- **ä¸¤éæ¨ç†**ï¼šå…ˆçœ‹å…¨ç¯‡ï¼Œæ„Ÿå—æ•…äº‹çš„æ•´ä½“èµ·ä¼ã€‚å†æ ¹æ®è¯­é€Ÿï¼ˆæ™®é€šè¯çº¦æ¯ç§’5-7å­—ï¼‰è¯„ä¼°ï¼šå¦‚æœä¸€æ®µè¯è¯»å®Œè¶…è¿‡5-6ç§’ï¼ˆçº¦35å­—ï¼‰ï¼Œä½ å¿…é¡»å¯»æ‰¾æ–‡æ¡ˆä¸­çš„â€œå‘¼å¸æ„Ÿæ–­ç‚¹â€è¿›è¡Œæ‹†åˆ†ï¼Œä»¥ç¡®ä¿è§†é¢‘æ—¶é•¿èƒ½è¦†ç›–éŸ³é¢‘ã€‚
- **è§†è§‰èšåˆ**ï¼šå¦‚æœè¿ç»­å‡ ä¸ªçŸ­ä¿ƒçš„åŠ¨ä½œå‘ç”Ÿåœ¨åŒä¸€ç”»é¢å†…ï¼Œè¯·åˆå¹¶å®ƒä»¬ã€‚
- **ç«–å±æ€è€ƒ**ï¼šé€‚é… 9:16ã€‚

ã€åº•çº¿ã€‘
- ä¸¥ç¦é—æ¼åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ï¼Œä¸¥ç¦æ”¹å˜åŸæ–‡ç»“æ„ã€‚
- åªè¾“å‡ºåˆ†é•œåºå·å’Œåˆ†é•œæ–‡æ¡ˆã€‚
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.4 # ç»™ AI ä¸€ç‚¹çµæ„Ÿç©ºé—´
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_res'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œè§„åˆ’å¤±è´¥ï¼š{str(e)}")

with col_board:
    final_script_v1 = st.text_area("2. å¯¼æ¼”åˆ†é•œè‰æ¡ˆï¼ˆå¯æ‰‹åŠ¨è°ƒæ•´ï¼‰", 
                                  value=st.session_state.get('step1_res', ''), 
                                  height=400)
    st.caption("æ³¨ï¼šåœ¨æ­¤ç¡®è®¤åˆ†é•œæ–‡æ¡ˆé•¿åº¦é€‚ä¸­ï¼ˆè¯»èµ·æ¥çº¦4-5ç§’ï¼‰ï¼Œä¸”è§†è§‰ç„¦ç‚¹æ˜ç¡®ã€‚")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æç¤ºè¯ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰è¯­è¨€è½¬åŒ–ï¼ˆMJæç¤ºè¯ + å³æ¢¦è§†é¢‘æŒ‡ä»¤ï¼‰")

use_char = st.checkbox("æ³¨å…¥è§’è‰²ä¸€è‡´æ€§å‚è€ƒ", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥æ ¸å¿ƒäººç‰©å¤–è²Œè®¾å®šï¼ˆæœè£…ã€å‘é¥°ã€é•¿ç›¸ç»†èŠ‚ï¼‰", 
                               placeholder="èµµå°˜ï¼šå†·é…·ç”·äººï¼Œé»‘å‘æŸå† ï¼Œç„è‰²é”¦è¢...\nå®‰å¦™è¡£ï¼šè‚¤ç™½å¦‚é›ªï¼Œé“¶ä¸è´è¶ç°ª...", 
                               height=150)

if st.button("ğŸ¨ ç”Ÿæˆè§†è§‰æç¤ºè¯"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€æ­¥åˆ†é•œã€‚")
    else:
        with st.spinner("æ­£åœ¨å°†æ–‡å­—ç¿»è¯‘ä¸ºè§†è§‰ä¿¡å·..."):
            # è§†è§‰ç”ŸæˆæŒ‡ä»¤
            step2_prompt = f"""
ä½ æ˜¯ä¸€åæ¼«å‰§è§†è§‰æ€»ç›‘ã€‚è¯·ä¸ºæ¯ä¸ªåˆ†é•œç”Ÿæˆç”»é¢æè¿°ï¼ˆç»™Midjourneyï¼‰å’ŒåŠ¨æ€æè¿°ï¼ˆç»™å³æ¢¦AIï¼‰ã€‚

ã€è§’è‰²ä¸€è‡´æ€§æ¡£æ¡ˆã€‘ï¼š
{char_detail}

ã€è§†è§‰è¡¨ç°å‡†åˆ™ã€‘ï¼š
1. ã€ç”»é¢æè¿° (MJ)ã€‘ï¼š
   - é€‚é… 9:16ã€‚æè¿°é™æ€ç”»é¢ã€‚
   - åŒ…å«ï¼šç¯å¢ƒåœºæ™¯ã€è§’è‰²ï¼ˆä¸¥æ ¼å¥—ç”¨å‚è€ƒè¯ï¼‰ã€è¡¨æƒ…ç¥æ€ã€æ™¯åˆ«ï¼ˆå¤šç”¨ç‰¹å†™/ä¸­æ™¯ï¼Œä½“ç°æƒ…ç»ªï¼‰ã€è§†è§’ã€‚
   - ä¸è¦å†™åŠ¨è¯ã€‚
2. ã€è§†é¢‘ç”Ÿæˆ (å³æ¢¦)ã€‘ï¼š
   - æè¿°åŸºäºè¯¥ç”»é¢çš„åŠ¨æ€ã€‚
   - ä¾‹å¦‚ï¼šé•œå¤´ç¼“æ…¢æ¨è¿‘ã€äººç‰©çœ¼ç«æ¯›é¢¤åŠ¨ã€å˜´è§’ä¸Šæ‰¬ã€‚
   - åŠ¨ä½œå¿…é¡»åœ¨5ç§’å†…è‡ªç„¶å®Œæˆã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼šåœºæ™¯å†…å®¹ï¼Œ[è§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´æè¿°ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼šåŠ¨æ€åŠ¨ä½œæè¿°ï¼Œé•œå¤´è¯­è¨€è½¨è¿¹ï¼Œæƒ…ç»ªèµ·ä¼
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.5
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=240)
                st.session_state['step2_res'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"ç”Ÿæˆæç¤ºè¯å¤±è´¥ï¼š{str(e)}")

if 'step2_res' in st.session_state:
    st.subheader("ğŸ“ æœ€ç»ˆå¯¼æ¼”è„šæœ¬è¾“å‡º")
    st.text_area("é¢„è§ˆç»“æœ", st.session_state['step2_res'], height=600)
    st.download_button("ğŸ“¥ ä¸‹è½½å®Œæ•´å¯¼æ¼”ç¨¿", st.session_state['step2_res'], file_name="æœ€ç»ˆåˆ†é•œå¯¼æ¼”ç¨¿.txt")
