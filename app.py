import streamlit as st
from openai import OpenAI
import re

# 1. é¡µé¢é…ç½®
st.set_page_config(page_title="ç”µå½±çº§åˆ†é•œå¤§å¸ˆ v3.0", layout="wide", page_icon="ğŸ¬")

if 'step1_result' not in st.session_state:
    st.session_state['step1_result'] = ""

# 2. ä¾§è¾¹æ é…ç½®
st.sidebar.title("âš™ï¸ ç³»ç»Ÿè®¾ç½®")
api_key = st.sidebar.text_input("API Key", type="password")
base_url = st.sidebar.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")

model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "è‡ªå®šä¹‰æ¨¡å‹ (æ‰‹åŠ¨è¾“å…¥)"]
selected_option = st.sidebar.selectbox("é€‰æ‹©æ¨¡å‹", model_options)
if selected_option == "è‡ªå®šä¹‰æ¨¡å‹ (æ‰‹åŠ¨è¾“å…¥)":
    model_id = st.sidebar.text_input("è¯·è¾“å…¥å…·ä½“çš„ Model ID")
else:
    model_id = selected_option

st.title("ğŸ¬ ç”µå½±è§£è¯´å…¨æµç¨‹åˆ†é•œå·¥å…·")
st.caption("è§†è§‰é€»è¾‘åˆ†é•œ | è¿è´¯å™äº‹ | é›¶å¢åˆ æ”¹åŸæ–‡")

# --- ç¬¬ä¸€é˜¶æ®µï¼šæ™ºèƒ½èŠ‚å¥åˆ†é•œ ---
st.header("ç¬¬ä¸€æ­¥ï¼šå™äº‹èŠ‚å¥åˆ†é•œ")
st.info("ğŸ’¡ é€»è¾‘å‡çº§ï¼šAI ç°åœ¨ä¼šåƒå‰ªè¾‘å¸ˆä¸€æ ·ï¼Œå°†å…³è”æ€§å¼ºçš„çŸ­å¥åˆå¹¶ï¼Œç¡®ä¿æ¯ä¸ª 5 ç§’çš„åˆ†é•œéƒ½æœ‰è¶³å¤Ÿçš„â€˜æˆä»½â€™ã€‚")

uploaded_file = st.file_uploader("ğŸ“‚ ä¸Šä¼ æ–‡æ¡ˆ (TXT)", type=['txt'])

if uploaded_file:
    raw_bytes = uploaded_file.getvalue()
    try:
        raw_text = raw_bytes.decode("utf-8")
    except:
        raw_text = raw_bytes.decode("gbk")
    
    # å½»åº•æŠ¹é™¤æ¢è¡Œï¼Œä½œä¸ºçº¯æ–‡æœ¬æµè¾“å…¥
    clean_stream = "".join(raw_text.split())

    if st.button("ğŸš€ ç”Ÿæˆç”µå½±æ„Ÿåˆ†é•œéª¨æ¶", use_container_width=True):
        if not api_key or not model_id:
            st.error("âŒ è¯·å…ˆå®Œæˆè®¾ç½®")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            
            # ç¬¬ä¸€æ­¥æç¤ºè¯ï¼šå¢åŠ åˆå¹¶é€»è¾‘ï¼Œå¼ºè°ƒè§†è§‰èŠ‚æ‹
            STEP1_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰ç”µå½±æ„Ÿæ€ç»´çš„èµ„æ·±åˆ†é•œå¸ˆã€‚
ä½ çš„ä»»åŠ¡æ˜¯å°†æä¾›çš„ã€æ–‡å­—æµã€‘é‡ç»„ä¸ºã€å™äº‹åˆ†é•œã€‘ã€‚

### åˆ†é•œåˆå¹¶é€»è¾‘ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰ï¼š
1. **æ‹’ç»ç¢ç‰‡åŒ–**ï¼šç¦æ­¢ç®€å•åœ°æ¯å¥è¯åˆ†ä¸€è¡Œã€‚å¦‚æœè¿ç»­çš„å‡ å¥è¯æè¿°çš„æ˜¯åŒä¸€ä¸ªåŠ¨ä½œã€åŒä¸€ä¸ªåœºæ™¯ï¼Œè¯·åŠ¡å¿…å°†å®ƒä»¬ã€åˆå¹¶ã€‘åœ¨åŒä¸€ä¸ªåˆ†é•œåºå·ä¸‹ã€‚
2. **5ç§’/35å­—é™åˆ¶**ï¼šåˆå¹¶åçš„æ–‡å­—æ€»æ•°ä¸¥ç¦è¶…è¿‡35-40ä¸ªæ±‰å­—ï¼ˆä¸ºäº†å¯¹é½5ç§’è§†é¢‘ï¼‰ã€‚
3. **è§†è§‰åˆ‡åˆ†ç‚¹**ï¼šåªæœ‰å½“å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œæ‰å¿…é¡»åˆ‡æ¢æ–°åˆ†é•œï¼š
   - åœºæ™¯æ”¹å˜ï¼ˆä»å®¤å†…åˆ°å®¤å¤–ï¼‰ã€‚
   - äººç‰©å¤§å¹…åº¦åŠ¨ä½œåˆ‡æ¢ï¼ˆä»å¥”è·‘åˆ°åœä¸‹ï¼‰ã€‚
   - å¯¹è¯äººåˆ‡æ¢ã€‚
   - æƒ…æ„ŸèŠ‚å¥çš„å‰§çƒˆè½¬æŠ˜ã€‚
4. **é›¶å¢åˆ æ”¹åè®®**ï¼šä¸å‡†æ”¹å­—ï¼Œä¸å‡†åˆ å­—ï¼Œä¸å‡†åŠ æˆã€‚åªéœ€å°†åŸæ–‡æŒ‰é€»è¾‘åˆå¹¶æˆ–åˆ‡åˆ†ã€‚

### ç¤ºä¾‹é€»è¾‘å¯¹ç…§ï¼š
åŸæ–‡æµï¼šä»–æ¨å¼€é—¨ã€‚èµ°äº†è¿›å»ã€‚ç¯é¡¾å››å‘¨ã€‚å‘ç°ç©ºæ— ä¸€äººã€‚ä»–å¹äº†å£æ°”ã€‚
ç¢ç‰‡åˆ†é•œï¼ˆå·®ï¼‰ï¼š
1.ä»–æ¨å¼€é—¨ã€‚
2.èµ°äº†è¿›å»ã€‚
3.ç¯é¡¾å››å‘¨ã€‚
4.å‘ç°ç©ºæ— ä¸€äººã€‚
5.ä»–å¹äº†å£æ°”ã€‚
ç”µå½±æ„Ÿåˆ†é•œï¼ˆå¥½ï¼‰ï¼š
1.ä»–æ¨å¼€é—¨èµ°äº†è¿›å»ï¼Œç¯é¡¾å››å‘¨ï¼Œå‘ç°ç©ºæ— ä¸€äººã€‚ï¼ˆæ€»å­—æ•°20ï¼Œé€‚åˆ5ç§’ï¼ŒåŠ¨ä½œè¿è´¯ï¼‰
2.ä»–å¹äº†å£æ°”ã€‚

è¯·å¯¹ä»¥ä¸‹æ–‡å­—æµè¿›è¡Œå…·æœ‰ç”µå½±å™äº‹æ„Ÿçš„é‡ç»„åˆ†é•œï¼š"""

            with st.spinner("å¯¼æ¼”æ­£åœ¨æ„æ€å™äº‹èŠ‚å¥..."):
                try:
                    response = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": STEP1_PROMPT},
                            {"role": "user", "content": clean_stream}
                        ],
                        temperature=0.2
                    )
                    st.session_state['step1_result'] = response.choices[0].message.content
                except Exception as e:
                    st.error(f"å‡ºé”™ï¼š{str(e)}")

if st.session_state['step1_result']:
    st.subheader("ğŸ“‹ å™äº‹åˆ†é•œè„šæœ¬")
    st.session_state['step1_result'] = st.text_area("æ£€æŸ¥èŠ‚å¥æ˜¯å¦åˆç†ï¼Œå¯æ‰‹åŠ¨è°ƒæ•´åˆå¹¶æˆ–æ‹†åˆ†", st.session_state['step1_result'], height=300)

    st.markdown("---")

    # --- ç¬¬äºŒé˜¶æ®µï¼šæ·±åº¦è§†è§‰æè¿° ---
    st.header("ç¬¬äºŒæ­¥ï¼šè§†è§‰ä¸é•œå¤´åŠ¨æ€è®¾è®¡")
    
    char_desc = st.text_area("ğŸ‘¤ è§’è‰²åŠç€è£…æ ¸å¿ƒè®¾å®š", 
                             placeholder="æ—å‡¡ï¼š20å²ï¼Œç„è‰²é•¿è¢ï¼Œè…°é—´æŒ‚å‰‘ï¼Œç›®å…‰é”åˆ©ã€‚\næŸ³ä¾ä¾ï¼š18å²ï¼Œæ·¡ç´«è‰²çº±è£™ï¼Œæ­¥æ‘‡éšé£åŠ¨ã€‚",
                             height=100)
    
    if st.button("ğŸ¨ ç”Ÿæˆæ·±åº¦è§†è§‰æè¿°", use_container_width=True):
        if not char_desc:
            st.error("âŒ è§’è‰²æè¿°æ˜¯ç»´æŒç”»é¢ä¸€è‡´æ€§çš„å…³é”®ï¼Œè¯·å¡«å†™ã€‚")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            
            # ç¬¬äºŒæ­¥æç¤ºè¯ï¼šå¼ºè°ƒâ€œæˆä»½â€å’Œâ€œåŠ¨æ€æ„Ÿâ€
            STEP2_PROMPT = f"""ä½ æ˜¯ä¸€ä¸ªç”µå½±è§†è§‰å¯¼æ¼”ã€‚è¯·æ ¹æ®æä¾›çš„ã€åˆ†é•œè„šæœ¬ã€‘å’Œã€è§’è‰²è®¾å®šã€‘ï¼Œè®¾è®¡å……æ»¡æ•…äº‹æ„Ÿçš„ç”»é¢ã€‚

è§’è‰²è®¾å®šï¼š{char_desc}

### è¾“å‡ºè§„èŒƒï¼š
[åºå·]. [æ–‡æ¡ˆå†…å®¹]
ç”»é¢æè¿°ï¼ˆMJåº•å›¾ï¼‰ï¼š[é™æ€è§†è§‰ï¼šåœºæ™¯æ·±åº¦ç»†èŠ‚ã€å…‰å½±æ°›å›´ã€äººç‰©ç²¾ç»†å¤–è²Œã€ç€è£…æè´¨ã€è§†è§’æ„å›¾ã€‚ä¸¥ç¦åŠ¨è¯ã€‚]
è§†é¢‘ç”Ÿæˆï¼ˆå³æ¢¦/LumaåŠ¨æ€ï¼‰ï¼š[åŠ¨æ€æ¼”ç»ï¼šåŸºäºç”»é¢ï¼Œæè¿°äººç‰©çš„è¿è´¯åŠ¨ä½œè¡Œä¸ºã€ç»†å¾®ç¥æ€æ¼”å˜ï¼ˆå¦‚ï¼šä»ç–‘æƒ‘è½¬ä¸ºæƒŠæï¼‰ã€é•œå¤´çš„ç²¾ç¡®è¿åŠ¨ï¼ˆå¦‚ï¼šä½è§’åº¦å¿«é€Ÿè·Ÿæ‹ï¼‰ã€‚]
---
### æ ¸å¿ƒè¦æ±‚ï¼š
1. **æ–‡æ¡ˆå¤è¯»**ï¼šå¿…é¡»åŸæ ·ä½¿ç”¨åˆ†é•œè„šæœ¬é‡Œçš„æ–‡å­—ã€‚
2. **å¢å¼ºåŠ¨æ€æ„Ÿ**ï¼šè§†é¢‘ç”Ÿæˆéƒ¨åˆ†è¦æè¿°å‡ºæœ‰â€œæˆâ€çš„åŠ¨ä½œï¼Œè®©ç”»é¢æ´»èµ·æ¥ã€‚
3. **è§†è§‰è¿ç»­æ€§**ï¼šæ¯ä¸ªåˆ†é•œå¿…é¡»å®Œæ•´åŒ…å«è§’è‰²ç‰¹å¾ï¼Œé˜²æ­¢è·³æˆã€‚"""

            with st.spinner("ç¾æœ¯å¯¼æ¼”æ­£åœ¨ç»˜åˆ¶åˆ†é•œå›¾..."):
                try:
                    response = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": STEP2_PROMPT},
                            {"role": "user", "content": st.session_state['step1_result']}
                        ],
                        temperature=0.5
                    )
                    final_output = response.choices[0].message.content
                    st.subheader("ğŸ¥ æœ€ç»ˆå…¨æµç¨‹åˆ¶ä½œæ–¹æ¡ˆ")
                    st.write(final_output)
                    st.download_button("ğŸ“¥ ä¸‹è½½åˆ¶ä½œè„šæœ¬", final_output, file_name="ç”µå½±æ„Ÿåˆ†é•œè„šæœ¬.txt")
                except Exception as e:
                    st.error(f"å¤„ç†å¤±è´¥: {str(e)}")

st.markdown("---")
st.caption("å¯¼æ¼”æç¤ºï¼šåˆ†é•œçš„æœ¬è´¨æ˜¯â€˜æˆâ€™ï¼Œåˆå¹¶çŸ­å¥èƒ½è®©æ¯ä¸ªé•œå¤´æœ‰æ›´å¤šç©ºé—´å»å±•ç°äººç‰©çš„åŠ¨ä½œå’Œæƒ…ç»ªã€‚")
