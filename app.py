import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”åˆ†é•œå¤§å¸ˆ v12.0", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ ï¼šAPI ä¸è‡ªå®šä¹‰æ¨¡å‹é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”å·¥ä½œå®¤é…ç½®")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "grok-beta", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("è¯·è¾“å…¥å…·ä½“çš„ Model ID")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§åˆ†é•œç³»ç»Ÿ v12.0")
st.error("ğŸš€ æ ¸å¿ƒçº¢çº¿ï¼šä¸€ä¸ªåˆ†é•œ=ä¸€ä¸ªè§†è§‰åŸå­ï¼ˆå•ä¸€ç©ºé—´ã€å•ä¸€å¾®åŠ¨ä½œã€35å­—ä¸Šé™ã€9:16æ„å›¾ï¼‰ã€‚")

# --- ç¬¬ä¸€é˜¶æ®µï¼šè§†è§‰åŸå­åŒ–ç²¾ç»†åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šè§†è§‰åŸå­æ‹†è§£ï¼ˆç¡®ä¿â€œä¸€é•œä¸€ç”»â€çš„å¯è¡Œæ€§ï¼‰")

col_script, col_board = st.columns(2)

with col_script:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="åœ¨æ­¤è¾“å…¥å‰§æœ¬æ–‡æ¡ˆ...")
    
    if st.button("ğŸš€ æ‰§è¡Œè§†è§‰åŸå­åˆ†é•œ"):
        if not api_key or not final_model_id:
            st.error("è¯·å®Œå–„ API é…ç½®ä¿¡æ¯ã€‚")
        elif not raw_script:
            st.warning("æ–‡æ¡ˆä¸ºç©ºã€‚")
        else:
            with st.spinner("å¯¼æ¼”æ­£åœ¨è¯„ä¼°ç«–å±æ„å›¾ä¸åŠ¨ä½œå¯è¡Œæ€§..."):
                # v12.0 æ ¸å¿ƒæŒ‡ä»¤ï¼šè§†è§‰å¯è¡Œæ€§
                step1_prompt = """
ä½ æ˜¯ä¸€åä¸“é—¨ä»äº‹ 9:16 ç«–å±æ¼«å‰§åˆ›ä½œçš„é¡¶çº§å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯è¿›è¡Œã€åŸå­çº§åˆ†é•œæ‹†è§£ã€‘ã€‚

ã€æœ€é«˜å‡†åˆ™ï¼šè§†è§‰å¯è¡Œæ€§æ ¡éªŒã€‘
1. **ä¸€é•œä¸€æ„ï¼ˆåŸå­åŒ–ï¼‰**ï¼šä¸€ä¸ªåˆ†é•œåªèƒ½åŒ…å«ä¸€ä¸ªã€å•ä¸€ç”»é¢ã€‘èƒ½å‘ˆç°çš„å†…å®¹ã€‚
   - **ä¸¥ç¦ä½ç§»**ï¼šå¦‚æœæ–‡æ¡ˆåŒ…å«ä» A ç‚¹èµ°åˆ° B ç‚¹çš„è¿‡ç¨‹ï¼Œå¿…é¡»æ‹†åˆ†ä¸ºä¸¤ä¸ªåˆ†é•œï¼ˆå‡ºå‘ç‚¹å’Œåˆ°è¾¾ç‚¹ï¼‰ã€‚
   - **å¾®åŠ¨ä½œå‡†åˆ™**ï¼šå³æ¢¦AIåªæœ‰5ç§’ã€‚ä¸€ä¸ªåˆ†é•œå†…åªå…è®¸å­˜åœ¨ä¸€ä¸ªå¾®å°çš„ã€è¿è´¯çš„åŠ¨ä½œï¼ˆå¦‚ï¼šæŠ¬å¤´ã€è½æ³ªã€å†·ç¬‘ã€ä¼¸æ‰‹ï¼‰ã€‚ä¸¥ç¦å‡ºç°å¤åˆè¿è´¯åŠ¨ä½œï¼ˆå¦‚ï¼šä»–è¿›é—¨ã€åä¸‹ã€å–èŒ¶ï¼‰ã€‚
2. **9:16 æ„å›¾æ„è¯†**ï¼š
   - ç«–å±æ¨ªå‘ç©ºé—´æçª„ã€‚å¦‚æœæ–‡æ¡ˆæ¶‰åŠå·¦å³ä¸¤ä¸ªäººçš„å¤æ‚äº’åŠ¨ï¼Œè¯·æ‹†åˆ†ä¸ºä¸¤ä¸ªåˆ†é•œï¼Œé€šè¿‡ç‰¹å†™æ¥å›åˆ‡ã€‚
3. **æ—¶é•¿çº¢çº¿**ï¼šå•åˆ†é•œæ–‡æ¡ˆã€ä¸Šé™ 35 å­—ã€‘ã€‚
4. **æ— æŸè¿˜åŸ**ï¼šå¿…é¡» 100% ä¿ç•™åŸæ–‡æ¯ä¸€ä¸ªå­—ï¼Œä¸¥ç¦å¢å‡ã€‚

ã€æ‰§è¡Œé€»è¾‘ã€‘ï¼š
- ç¬¬ä¸€éï¼šé˜…è¯»å…¨æ–‡ï¼Œè¯†åˆ«è§†è§‰é‡å¿ƒçš„è½¬ç§»ç‚¹ã€‚
- ç¬¬äºŒéï¼šå¯¹æ–‡æ¡ˆè¿›è¡ŒåŸå­åŒ–åˆ‡å‰²ã€‚åªè¦ç”»é¢æ‰¿è½½ä¸äº†ï¼Œå°±å¿…é¡»åˆ‡ã€‚

è¾“å‡ºæ ¼å¼ï¼š
1.å†…å®¹...
2.å†…å®¹...
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.2
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_res'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œè§„åˆ’å¤±è´¥ï¼š{str(e)}")

with col_board:
    final_script_v1 = st.text_area("2. å¯¼æ¼”åŸå­åˆ†é•œè‰æ¡ˆï¼ˆå¯æ‰‹åŠ¨è°ƒæ•´ï¼‰", 
                                  value=st.session_state.get('step1_res', ''), 
                                  height=400)
    st.caption("ğŸ’¡ æ£€æŸ¥ç‚¹ï¼šæ¯ä¸ªåºå·å†…çš„å†…å®¹ï¼Œæ˜¯å¦èƒ½ç”¨ä¸€å¼ ç«–å±å›¾ï¼ˆåŠ5ç§’åŠ¨ä½œï¼‰å®Œæ•´è¡¨è¾¾ï¼Ÿ")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰æŒ‡ä»¤é›†ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰è¯­è¨€è½¬åŒ–ï¼ˆMJ + å³æ¢¦ï¼‰")

use_char = st.checkbox("æ³¨å…¥è§’è‰²å¤–è²Œ/ç€è£…ä¸€è‡´æ€§è®¾å®š", value=True)
char_detail = ""
if use_char:
    char_detail = st.text_area("è¾“å…¥æ ¸å¿ƒäººç‰©è®¾å®šè¯ï¼ˆMJç”Ÿæˆå…³é”®ï¼‰", height=150, placeholder="èµµå°˜ï¼šç„è‰²é”¦è¢... å®‰å¦™è¡£ï¼šç™½è‰²ç½—è£™ï¼Œæ­¥æ‘‡...")

if st.button("ğŸ¨ ç”Ÿæˆè§†è§‰æç¤ºè¯å…¨æ¡ˆ"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µã€‚")
    else:
        with st.spinner("æ­£åœ¨ä¼˜åŒ– 9:16 è§†è§‰æ„å›¾æç¤ºè¯..."):
            step2_prompt = f"""
ä½ æ˜¯ä¸€åèµ„æ·±æ¼«å‰§è§†è§‰æŒ‡å¯¼ã€‚è¯·æ ¹æ®åˆ†é•œç”Ÿæˆ Midjourney æç¤ºè¯å’Œè§†é¢‘åŠ¨æ€æŒ‡ä»¤ã€‚

ã€æ ¸å¿ƒè§’è‰²å‚è€ƒã€‘ï¼š
{char_detail}

ã€è§†è§‰è¡¨ç°è§„èŒƒã€‘ï¼š
1. **ç”»é¢æè¿° (MJ)**ï¼š
   - å¿…é¡»åŒ…å«ï¼š--ar 9:16ã€‚
   - **ç«–å±æ„å›¾é€»è¾‘**ï¼šé‡ç‚¹æè¿°å‚ç›´ç©ºé—´ï¼ˆå¦‚ï¼šèƒŒæ™¯çš„é«˜å¢™ã€å‚ä¸‹çš„æµè‹ã€äººç‰©çš„å…¨èº«æˆ–ç‰¹å†™ï¼‰ã€‚
   - **æ™¯åˆ«ç²¾å‡†**ï¼šåŸå­åŒ–åˆ†é•œåï¼Œå¤šç”¨â€œä¸­æ™¯â€å’Œâ€œç‰¹å†™â€ï¼Œç¡®ä¿è§’è‰²ç¥æ€æ¸…æ™°ã€‚
2. **è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)**ï¼š
   - æè¿° 5 ç§’å†…çš„åŸå­åŠ¨ä½œï¼ˆå‘ä¸åŠ¨ã€çœ¨çœ¼ã€å˜´è§’å¾®åŠ¨ï¼‰ã€‚
   - å¿…é¡»æœ‰é•œå¤´è¯­è¨€ï¼ˆPush in, Zoom out, Tilt up/downï¼‰ã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼š[9:16ç«–å±æ„å›¾æè¿°]ï¼Œ[å›ºå®šè§’è‰²è®¾å®šè¯]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œæ°›å›´è¯´æ˜ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼š[5ç§’å†…åŸå­åŠ¨ä½œ]ï¼Œ[é•œå¤´è¿åŠ¨è½¨è¿¹]ï¼Œæƒ…ç»ªèŠ‚å¥
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.4
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=300)
                st.session_state['step2_res'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"ç”Ÿæˆæç¤ºè¯å¤±è´¥ï¼š{str(e)}")

if 'step2_res' in st.session_state:
    st.text_area("ğŸ“‹ æœ€ç»ˆæ¼«å‰§å¯¼æ¼”è„šæœ¬", st.session_state['step2_res'], height=600)
    st.download_button("ğŸ“¥ å¯¼å‡ºåˆ†é•œæ–‡ä»¶", st.session_state['step2_res'], file_name="æ¼«å‰§åˆ†é•œå…¨æ¡ˆV12.txt")
