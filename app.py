import streamlit as st
import requests
import json

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”çº§åˆ†é•œå¤§å¸ˆ", layout="wide", page_icon="ğŸ¬")

# è‡ªå®šä¹‰ CSS
st.markdown("""
    <style>
    .stTextArea textarea { font-size: 14px !important; }
    .status-box { padding: 10px; border-radius: 5px; background-color: #f0f2f6; border-left: 5px solid #FF4B4B; }
    </style>
    """, unsafe_allow_html=True)

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§åˆ†é•œè‡ªåŠ¨å¤„ç†ç³»ç»Ÿ")
st.caption("é›†æˆï¼šç²¾å‡†åˆ†é•œæ‹†è§£ | è§’è‰²ä¸€è‡´æ€§æ§åˆ¶ | MJ æç¤ºè¯ | å³æ¢¦è§†é¢‘åŠ¨æ€æŒ‡ä»¤")

# --- ä¾§è¾¹æ ï¼šé…ç½®åŒº ---
with st.sidebar:
    st.header("âš™ï¸ å…¨å±€é…ç½®")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.subheader("ğŸ¤– æ¨¡å‹é€‰æ‹©")
    model_list = ["gpt-4o", "claude-3-5-sonnet-20240620", "grok-beta", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_option = st.selectbox("é€‰æ‹©æ¨¡å‹", options=model_list)
    
    if selected_option == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("æ‰‹åŠ¨è¾“å…¥ Model ID", value="")
    else:
        final_model_id = selected_option

    st.markdown("---")
    st.warning("""
    **åˆ†é•œå‡†åˆ™ï¼š**
    1. ç”»é¢æ¯”ä¾‹ 9:16ã€‚
    2. æ–‡æ¡ˆé™é•¿ï¼šæ¯ä¸ªåˆ†é•œ < 35å­—ï¼ˆçº¦5ç§’ï¼‰ã€‚
    3. é€»è¾‘ï¼šåˆæ‹† -> å…¨æ–‡æ¨ç† -> ç²¾æ‹†ä¸åˆå¹¶ã€‚
    """)

# --- ä¸»ç•Œé¢ï¼šæ•°æ®å¯¼å…¥ ---
col_file1, col_file2 = st.columns(2)

with col_file1:
    st.subheader("1. å¯¼å…¥å‰§æœ¬æ–‡æ¡ˆ")
    story_file = st.file_uploader("ä¸Šä¼ æ–‡æ¡ˆ (.txt)", type=["txt"], key="story")
    story_text = ""
    if story_file:
        story_text = story_file.read().decode("utf-8", errors="ignore")
        st.text_area("æ–‡æ¡ˆé¢„è§ˆ", story_text, height=200)

with col_file2:
    st.subheader("2. å¯¼å…¥è§’è‰²è®¾å®š")
    char_file = st.file_uploader("ä¸Šä¼ è§’è‰²å¤–è¡¨/ç€è£…æè¿° (.txt)", type=["txt"], key="char")
    char_text = ""
    if char_file:
        char_text = char_file.read().decode("utf-8", errors="ignore")
        st.text_area("è§’è‰²å‚è€ƒé¢„è§ˆ", char_text, height=200)

# --- æ ¸å¿ƒé€»è¾‘å¤„ç† ---
if st.button("ğŸš€ å¼€å§‹äºŒæ¬¡ç²¾å‡†åˆ†é•œå¤„ç†"):
    if not api_key or not final_model_id:
        st.error("è¯·å®Œå–„å·¦ä¾§é…ç½®ä¿¡æ¯ã€‚")
    elif not story_text or not char_text:
        st.error("è¯·åŒæ—¶ä¸Šä¼ æ–‡æ¡ˆå’Œè§’è‰²è®¾å®šæ–‡ä»¶ã€‚")
    else:
        with st.spinner("å¯¼æ¼”æ­£åœ¨è¿›è¡ŒäºŒæ¬¡æ¨ç†ä¸åˆ†é•œè§„åˆ’ä¸­..."):
            
            # --- æ·±åº¦å¯¼æ¼” Prompt ---
            system_instruction = f"""
ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„æ¼«å‰§å¯¼æ¼”å’Œåˆ†é•œå¸ˆã€‚ä½ çš„ç›®æ ‡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„ã€è§’è‰²è®¾å®šã€‘å’Œã€æ–‡æ¡ˆã€‘ï¼Œç”Ÿæˆé€‚é… 9:16 æ¯”ä¾‹ã€Midjourney ç»˜ç”»ã€å³æ¢¦ AI è§†é¢‘ç”Ÿæˆçš„ç²¾å‡†åˆ†é•œè¡¨ã€‚

### è§’è‰²å‚è€ƒèµ„æ–™ï¼š
{char_text}

### æ‰§è¡Œæ­¥éª¤ä¸æ ¸å¿ƒé€»è¾‘ï¼š
1. **äºŒæ¬¡æ¨ç†é€»è¾‘**ï¼š
   - ç¬¬ä¸€éï¼šåˆæ­¥é˜…è¯»å…¨æ–‡ï¼Œç†è§£å‰§æƒ…èµ·ä¼ã€æƒ…ç»ªè½¬æŠ˜ã€‚
   - ç¬¬äºŒéï¼šç²¾å‡†æ‹†åˆ†ã€‚æ¯ä¸ªåˆ†é•œæ–‡æ¡ˆä¸¥æ ¼æ§åˆ¶åœ¨ 35 ä¸ªå­—ç¬¦ä»¥å†…ï¼ˆç¡®ä¿éŸ³é¢‘æ—¶é•¿ä¸è¶…è¿‡5ç§’ï¼‰ã€‚
   - å¦‚æœæŸæ®µæ–‡æ¡ˆå†…å®¹å¤ªå°‘ï¼ˆå¦‚ä»…1-5å­—ï¼‰ä¸”ç”»é¢æ„å¢ƒè¿è´¯ï¼Œåˆ™å°†å…¶ä¸å‰ååˆå¹¶ã€‚
   - å¦‚æœæŸå¥æ–‡æ¡ˆè¶…è¿‡35å­—æˆ–åŠ¨ä½œè¿‡äºå¤æ‚ï¼Œå¿…é¡»æ‹†åˆ†ä¸ºå¤šä¸ªåˆ†é•œã€‚

2. **ç”»é¢ä¸è§†é¢‘æè¿°åˆ†ç¦»åŸåˆ™**ï¼š
   - **ç”»é¢æè¿°ï¼ˆMJ æç¤ºè¯ï¼‰**ï¼šä»…æè¿°é™æ€å…ƒç´ ã€‚åŒ…å«åœºæ™¯ç¯å¢ƒã€å¤©æ°”å…‰å½±ã€äººç‰©å¤–è¡¨ï¼ˆä¸¥æ ¼å¼•ç”¨è§’è‰²å‚è€ƒï¼‰ã€ç€è£…ã€ç¥æ€ã€è§†è§’ï¼ˆä»°æ‹/ä¿¯æ‹/ç‰¹å†™ï¼‰ã€æ™¯åˆ«ï¼ˆè¿œæ™¯/ä¸­æ™¯/è¿‘æ™¯ï¼‰ã€‚ã€ç¦æ­¢æè¿°åŠ¨ä½œè¡Œä¸ºã€‘ã€‚
   - **è§†é¢‘ç”Ÿæˆï¼ˆå³æ¢¦/Lumaæè¿°ï¼‰**ï¼šåœ¨ç”»é¢åŸºç¡€ä¸Šæè¿°åŠ¨æ€ã€‚åŒ…å«äººç‰©çš„å…·ä½“åŠ¨ä½œã€é•œå¤´è¯­è¨€ï¼ˆå¹³ç§»ã€æ¨æ‹‰ã€è·Ÿæ‹ï¼‰ã€æƒ…ç»ªæ¼”å˜ã€‚ã€å¿…é¡»åŸºäºé™æ€ç”»é¢è¿›è¡Œæ‰©å±•ã€‘ã€‚

3. **è§†è§‰ä¸€è‡´æ€§è¦æ±‚**ï¼š
   - æ¯ä¸€å±å¿…é¡»æè¿°å½“å‰åœºæ™¯ï¼ˆå¦‚ï¼šäº¬åŸè¡—è§’ã€ç ´æ—§æŸ´æˆ¿ï¼‰ï¼Œç¡®ä¿åœºæ™¯ä¸è·³è·ƒã€‚
   - æ¯ä¸€ä¸ªåˆ†é•œå¿…é¡»å›ºå®šäººç‰©å¤–è¡¨å’Œç€è£…æè¿°ï¼Œç›´æ¥ä»è§’è‰²å‚è€ƒèµ„æ–™ä¸­æå–å…³é”®è¯ã€‚

### è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
[åºå·]. [å½“å‰åˆ†é•œå®Œæ•´æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼š[æè¿°ç¯å¢ƒã€å›ºå®šçš„äººç‰©å¤–è¡¨ç€è£…ã€æ™¯åˆ«ã€è§†è§’ã€æ°›å›´ã€9:16æ¯”ä¾‹æš—ç¤º]
è§†é¢‘ç”Ÿæˆï¼š[æè¿°é•œå¤´è¿åŠ¨è½¨è¿¹ã€äººç‰©åŠ¨ä½œã€æƒ…ç»ªå˜åŒ–ã€5ç§’å†…çš„åŠ¨æ€æµå‘]

---
å¼€å§‹å¤„ç†ä»¥ä¸‹æ–‡æ¡ˆï¼š
{story_text}
"""

            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": system_instruction},
                    {"role": "user", "content": "è¯·å¼€å§‹è¿›è¡ŒäºŒæ¬¡ç²¾å‡†åˆ†é•œï¼Œç¡®ä¿æ¯æ®µæ–‡æ¡ˆåœ¨35å­—ä»¥å†…ï¼Œå¹¶ç”Ÿæˆè¯¦ç»†çš„MJä¸è§†é¢‘æè¿°ã€‚"}
                ],
                "temperature": 0.3,
                "stream": False
            }

            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json"
            }

            try:
                response = requests.post(base_url, headers=headers, json=payload, timeout=300)
                if response.status_code == 200:
                    data = response.json()
                    final_result = data['choices'][0]['message']['content']
                    
                    st.success("åˆ†é•œè§„åˆ’å®Œæˆï¼")
                    st.subheader("ğŸ¥ æœ€ç»ˆåˆ†é•œè„šæœ¬")
                    st.text_area("ç»“æœè¾“å‡º", final_result, height=600)
                    
                    st.download_button(
                        label="ğŸ“¥ ä¸‹è½½åˆ†é•œè„šæœ¬",
                        data=final_result,
                        file_name="ç²¾å‡†åˆ†é•œç»“æœ.txt",
                        mime="text/plain"
                    )
                else:
                    st.error(f"æ¥å£è¿”å›é”™è¯¯: {response.text}")
            except Exception as e:
                st.error(f"å‘ç”Ÿå¼‚å¸¸: {str(e)}")

# --- åº•éƒ¨æ“ä½œæŒ‡å— ---
st.markdown("---")
with st.expander("ğŸ› ï¸ ä½¿ç”¨æŒ‡å—ï¼ˆå¿…è¯»ï¼‰"):
    st.write("""
    1. **è§’è‰²è®¾å®šæ–‡ä»¶æ ¼å¼å»ºè®®**ï¼š
       ä¾‹å¦‚ï¼š`èµµå°˜ï¼š20å²ç”·äººï¼Œå†·é…·ç‹çˆ·ï¼Œé»‘å‘æŸå† ï¼Œèº«ç©¿ç„è‰²é”¦è¢ï¼Œç»£é‡‘çº¿ã€‚`
    2. **ä¸ºä»€ä¹ˆè¦äºŒæ¬¡æ¨ç†ï¼Ÿ**ï¼š
       ç¬¬ä¸€æ¬¡æ¨ç†ç¡®å®šå¤§çº²ï¼Œç¬¬äºŒæ¬¡æ¨ç†é€šè¿‡å­—æ•°ï¼ˆ35å­—å‡†åˆ™ï¼‰ç¡®å®šåˆ†é•œçš„ç‰©ç†é•¿åº¦ï¼Œé˜²æ­¢éŸ³é¢‘ä¸è§†é¢‘æ—¶é•¿ä¸å¯¹ä½ã€‚
    3. **ç”»é¢ä¸è§†é¢‘çš„åŒºåˆ«**ï¼š
       - **ç”»é¢** æ˜¯ç»™ Midjourney ç”¨çš„ï¼Œå†³å®šäº†ç”»è´¨å’Œè§’è‰²æ ·å­ã€‚
       - **è§†é¢‘** æ˜¯ç»™å³æ¢¦ AI ç”¨çš„ï¼Œå†³å®šäº†ç”»é¢é‡Œçš„ç‹çˆ·æ˜¯â€œèµ°è¿‡å»â€è¿˜æ˜¯â€œè½¬è¿‡å¤´â€ã€‚
    """)
