import streamlit as st
import requests

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§å¯¼æ¼”å…¨æµç¨‹ç³»ç»Ÿ v13.0", layout="wide", page_icon="ğŸ¬")

# --- ä¾§è¾¹æ é…ç½® ---
with st.sidebar:
    st.header("âš™ï¸ å¯¼æ¼”å·¥ä½œå®¤é…ç½®")
    base_url = st.text_input("æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1/chat/completions")
    api_key = st.text_input("API Key", type="password")
    
    st.markdown("---")
    model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "âœ¨ è‡ªå®šä¹‰ Model ID"]
    selected_model = st.selectbox("é€‰æ‹©é©±åŠ¨æ¨¡å‹", options=model_options)
    
    if selected_model == "âœ¨ è‡ªå®šä¹‰ Model ID":
        final_model_id = st.text_input("æ‰‹åŠ¨è¾“å…¥ Model ID")
    else:
        final_model_id = selected_model

st.title("ğŸ¬ æ¼«å‰§å¯¼æ¼”çº§å…¨æµç¨‹åˆ†é•œç³»ç»Ÿ v13.0")
st.warning("ğŸ’¡ æ ¸å¿ƒå‡†åˆ™ï¼šæ–‡æ¡ˆç†è§£ä¸ºç‹ï¼Œç‰©ç†è§„åˆ™è¾…åŠ©ã€‚æ¯ä¸€é•œéƒ½å¿…é¡»æ˜¯ 9:16 æ¯”ä¾‹ä¸‹å¯å®ç°çš„è§†è§‰åŸå­ã€‚")

# --- ç¬¬ä¸€é˜¶æ®µï¼šå™äº‹é©±åŠ¨ç²¾ç»†åˆ†é•œ ---
st.subheader("ç¬¬ä¸€é˜¶æ®µï¼šå™äº‹é©±åŠ¨å‹åˆ†é•œï¼ˆè„‘å†…å»ºæ¨¡ + æ— æŸåˆ‡å‰²ï¼‰")

col_left, col_right = st.columns(2)

with col_left:
    raw_script = st.text_area("1. ç²˜è´´å‰§æœ¬åŸæ–‡", height=400, placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„åŸå§‹æ•…äº‹æ–‡æœ¬...")
    
    if st.button("ğŸš€ å¼€å§‹çµé­‚åˆ†é•œè§„åˆ’"):
        if not api_key or not final_model_id:
            st.error("è¯·å®Œå–„é…ç½®ã€‚")
        elif not raw_script:
            st.warning("å†…å®¹ä¸ºç©ºã€‚")
        else:
            with st.spinner("å¯¼æ¼”æ­£åœ¨è¿›è¡Œå…¨ç¯‡è§†è§‰å»ºæ¨¡ï¼Œåˆ†æåŠ¨ä½œä¸æƒ…æ„Ÿæµ..."):
                # v13.0 æ·±åº¦å¯¼æ¼” Promptï¼šå›å½’å™äº‹æœ¬è´¨
                step1_prompt = """
ä½ æ˜¯ä¸€åé¡¶çº§æ¼«å‰§å‰ªè¾‘å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æ–‡æ¡ˆå†…å®¹ï¼Œè¿›è¡Œã€äºŒæ¬¡è§†è§‰åŒ–ç²¾å‡†åˆ†é•œã€‘ã€‚

ã€ç¬¬ä¸€ä»»åŠ¡ï¼šå™äº‹ä¸ç”»é¢ç†è§£ï¼ˆæ ¸å¿ƒï¼‰ã€‘
1. **è„‘å†…å»ºæ¨¡**ï¼šå¿½ç•¥åŸæ–‡çš„æ®µè½ï¼Œè®¤çœŸé˜…è¯»å…¨æ–‡ï¼Œåœ¨å¤§è„‘ä¸­æ‹‰ç‰‡ã€‚
2. **å®šä¹‰è§†è§‰å•å…ƒ**ï¼šä¸€ä¸ªåˆ†é•œåº”æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é•œå¤´ï¼ˆShotï¼‰ã€‚å½“å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œå¿…é¡»åˆ‡æ¢åˆ†é•œï¼š
   - è§†è§‰ç„¦ç‚¹è½¬æ¢ï¼ˆå¦‚ï¼šä»çœ‹é—¨å¤–è½¬åˆ°çœ‹å¯¹æ–¹çš„çœ¼æ³ªï¼‰ã€‚
   - åŠ¨ä½œçš„èµ·æ­¢ç‚¹ï¼ˆå¦‚ï¼šåˆšè¦æŠ¬æ‰‹ -> æ‰‹è½ä¸‹ï¼‰ã€‚
   - å™äº‹èŠ‚å¥çš„å‘¼å¸æ„Ÿã€‚
3. **9:16 æ„å›¾é¢„åˆ¤**ï¼šç¡®ä¿æ¯ä¸€ä¸ªåˆ†é•œçš„å†…å®¹åœ¨ 9:16 ç«–å±æ¯”ä¾‹ä¸‹èƒ½å¤Ÿå®Œç¾å‘ˆç°ã€‚å¦‚æœå†…å®¹å¤ªå¤šå¯¼è‡´æ„å›¾æ‚ä¹±ï¼Œå¿…é¡»æ‹†åˆ†é•œå¤´ã€‚

ã€ç¬¬äºŒä»»åŠ¡ï¼šç‰©ç†è§„åˆ™è¾…åŠ©ï¼ˆçº¢çº¿ï¼‰ã€‘
1. **æ—¶é•¿é€‚é…**ï¼šè€ƒè™‘å³æ¢¦AIç”Ÿæˆçš„5ç§’é™åˆ¶ã€‚å•é•œæ–‡æ¡ˆå»ºè®®æ§åˆ¶åœ¨ 15-35 å­—ã€‚
2. **æš´åŠ›é™æ—¶**ï¼šå¦‚æœä¸€æ®µå™äº‹æå…¶è¿è´¯ä½†è¶…è¿‡ 35 å­—ï¼Œä½ å¿…é¡»æ‰¾åˆ°è¯­ä¹‰ä¸­çš„â€œæ°”å£â€è¿›è¡Œè§†è§‰è¿‡æ¸¡ï¼ˆå¦‚ï¼šä»è¿œæ™¯åˆ‡ç‰¹å†™ï¼‰ï¼Œä»è€Œæ‹†åˆ†æˆä¸¤ä¸ªåˆ†é•œã€‚

ã€ç¬¬ä¸‰ä»»åŠ¡ï¼šæ•°æ®æ— æŸï¼ˆåº•çº¿ï¼‰ã€‘
- **ä¸¥ç¦é—æ¼åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ï¼Œä¸¥ç¦ä¿®æ”¹ä»»ä½•æ ‡ç‚¹æˆ–å­—è¯ï¼Œä¸¥ç¦æ·»åŠ é¢å¤–å†…å®¹ã€‚** 

è¾“å‡ºï¼šä»…è¾“å‡ºåºå·.æ–‡æ¡ˆï¼ˆä¾‹å¦‚ï¼š1.å†…å®¹\n2.å†…å®¹ï¼‰ã€‚
"""
                payload = {
                    "model": final_model_id,
                    "messages": [
                        {"role": "system", "content": step1_prompt},
                        {"role": "user", "content": raw_script}
                    ],
                    "temperature": 0.3
                }
                try:
                    res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=200)
                    st.session_state['step1_res'] = res.json()['choices'][0]['message']['content']
                except Exception as e:
                    st.error(f"åˆ†é•œå¤±è´¥ï¼š{str(e)}")

with col_right:
    final_script_v1 = st.text_area("2. æœ€ç»ˆåˆ†é•œç¨¿ï¼ˆå¯æ‰‹åŠ¨å¾®è°ƒï¼‰", 
                                  value=st.session_state.get('step1_res', ''), 
                                  height=400)
    st.caption("æ£€æŸ¥å»ºè®®ï¼šæ–‡æ¡ˆå†…å®¹æ˜¯å¦è¿‡é•¿ï¼Ÿä¸€ä¸ªé•œå¤´èƒ½å¦è£…ä¸‹è¿™ä¸ªç”»é¢ï¼Ÿæ˜¯å¦ä¸¢å­—ï¼Ÿ")

st.markdown("---")

# --- ç¬¬äºŒé˜¶æ®µï¼šè§†è§‰å…¨æ¡ˆæè¿°ç”Ÿæˆ ---
st.subheader("ç¬¬äºŒé˜¶æ®µï¼šåˆ†é•œå›¾ (MJ) ä¸è§†é¢‘ (å³æ¢¦) æè¿°ç”Ÿæˆ")

use_char = st.checkbox("æ³¨å…¥è§’è‰²å¤–è²Œ/ç€è£…ä¸€è‡´æ€§æè¿°è¯", value=True)
char_desc = ""
if use_char:
    char_desc = st.text_area("è¾“å…¥æ ¸å¿ƒè§’è‰²è®¾å®šè¯ï¼ˆé•¿ç›¸ã€æœé¥°ç»†èŠ‚ï¼‰", 
                             placeholder="èµµå°˜ï¼šå†·å³»ç”·äººï¼Œé»‘å‘æŸå† ï¼Œç„è‰²åˆºç»£é”¦è¢...\nå®‰å¦™è¡£ï¼šè‚¤ç™½ï¼Œé“¶ä¸è´è¶ç°ª...", 
                             height=150)

if st.button("ğŸ¨ ç”Ÿæˆå…¨å¥—è§†è§‰æç¤ºè¯"):
    if not final_script_v1:
        st.error("è¯·å…ˆå®Œæˆç¬¬ä¸€é˜¶æ®µã€‚")
    else:
        with st.spinner("æ­£åœ¨æ ¹æ® 9:16 è§†è§‰ç¾å­¦è®¾è®¡ç”»é¢æ–¹æ¡ˆ..."):
            step2_prompt = f"""
ä½ æ˜¯ä¸€åèµ„æ·±æ¼«å‰§è§†è§‰æ€»ç›‘ã€‚è¯·ä¸ºä»¥ä¸‹åˆ†é•œç”Ÿæˆ MJ æç¤ºè¯å’Œè§†é¢‘åŠ¨æ€æŒ‡ä»¤ã€‚

ã€æ ¸å¿ƒè§’è‰²å‚è€ƒã€‘ï¼š
{char_desc}

ã€è§†è§‰ç”Ÿæˆè§„èŒƒã€‘ï¼š
1. **ç”»é¢æè¿° (MJ)**ï¼š
   - é€‚é… 9:16 æ¯”ä¾‹ã€‚æè¿°é™æ€ç”»é¢ï¼ˆåœºæ™¯ã€è§’è‰²ã€æ™¯åˆ«ã€è§†è§’ã€æ°›å›´ï¼‰ã€‚
   - **æ™¯åˆ«é€‰æ‹©**ï¼šæ ¹æ®æ–‡æ¡ˆæƒ…ç»ªã€‚å¤§åœºé¢ç”¨å…¨æ™¯ï¼Œå¯¹è¯/å¿ƒç†ç”¨ç‰¹å†™ã€‚
   - ç¦æ­¢æè¿°åŠ¨è¯åŠ¨ä½œã€‚
2. **è§†é¢‘ç”Ÿæˆ (å³æ¢¦ AI)**ï¼š
   - æè¿°åŸºäºè¯¥ç”»é¢çš„ 5 ç§’å†…åŠ¨æ€ã€‚
   - åŒ…å«ï¼šè§’è‰²å¾®è¡¨æƒ…ã€èº«ä½“å¾®åŠ¨ã€é•œå¤´æ¨æ‹‰å¹³ç§»è½¨è¿¹ã€‚
   - ç¡®ä¿åŠ¨æ€é€»è¾‘ç¬¦åˆæ–‡æ¡ˆè¡¨è¾¾çš„æƒ…ç»ªã€‚

è¾“å‡ºæ ¼å¼ï¼š
[åºå·]. [æ–‡æ¡ˆ]
ç”»é¢æè¿°ï¼š[9:16 æ„å›¾æè¿°]ï¼Œ[å›ºå®šè§’è‰²è®¾å®š]ï¼Œ[æ™¯åˆ«è§†è§’]ï¼Œå…‰å½±æ°›å›´ï¼Œ--ar 9:16
è§†é¢‘ç”Ÿæˆï¼š[åŠ¨ä½œæè¿°]ï¼Œ[é•œå¤´è¿åŠ¨è½¨è¿¹]ï¼Œæƒ…ç»ªæ¼”å˜æ§åˆ¶
"""
            payload = {
                "model": final_model_id,
                "messages": [
                    {"role": "system", "content": step2_prompt},
                    {"role": "user", "content": final_script_v1}
                ],
                "temperature": 0.4
            }
            try:
                res = requests.post(base_url, headers={"Authorization": f"Bearer {api_key}"}, json=payload, timeout=300)
                st.session_state['step2_res'] = res.json()['choices'][0]['message']['content']
            except Exception as e:
                st.error(f"æç¤ºè¯ç”Ÿæˆå¤±è´¥ï¼š{str(e)}")

if 'step2_res' in st.session_state:
    st.text_area("ğŸ“‹ å¯¼æ¼”æœ€ç»ˆå…¨æ¡ˆç¨¿", st.session_state['step2_res'], height=600)
    st.download_button("ğŸ“¥ å¯¼å‡ºåˆ†é•œå¯¼æ¼”ç¨¿", st.session_state['step2_res'], file_name="æ¼«å‰§åˆ†é•œå¯¼æ¼”ç¨¿.txt")
